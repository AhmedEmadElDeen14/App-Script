<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>إدارة حالات تجديد الطلاب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    /* Global Styles & RTL Fixes */
    html, body {
      font-family: 'Roboto', 'Arial', sans-serif; /* Prefer Roboto for Material, fallback to Arial */
      background-color: #f0f2f5; /* Light grey background for modern feel */
      padding: 0; /* Remove body padding, container will handle it */
      margin: 0;
      direction: rtl; /* Right-to-Left direction */
      text-align: right; /* Default text alignment */
    }

    /* Navbar Styling */
    nav {
      background-color: #1a237e; /* Darker blue for a professional look */
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 0 20px; /* Add some horizontal padding to the nav itself */
      position: relative; /* Ensure relative positioning for absolute children */
      height: 64px; /* Default Materialize Navbar height */
      line-height: 64px; /* Ensure content is vertically centered */
    }
    nav .nav-wrapper {
        position: relative; /* Essential for absolute positioning inside */
        height: 100%; /* Fill parent height */
        display: flex; /* Use flexbox for better alignment */
        align-items: center; /* Vertically center items */
        justify-content: space-between; /* Space out items */
    }
    nav .brand-logo {
      /* Adjusted for better positioning in RTL */
      position: static; /* Remove absolute positioning on large screens */
      transform: none; /* Remove transform */
      right: auto; /* Reset right */
      left: auto; /* Reset left */
      font-weight: 500;
      font-size: 1.8rem;
      padding-right: 0; /* Remove extra padding */
      margin-right: 0; /* Remove extra margin */
      order: 2; /* Order for flexbox: put logo in center (visually) */
      flex-grow: 1; /* Allow logo to take available space */
      text-align: center; /* Center logo text */
    }
    nav ul.left { /* Targeting the ul that contains the 'الرئيسية' button */
        position: static; /* Remove absolute positioning */
        transform: none; /* Remove transform */
        left: auto; /* Reset left */
        right: auto; /* Reset right */
        margin-left: 0;
        padding-left: 0;
        order: 1; /* Order for flexbox: put home button to the left */
        display: flex; /* Ensure it's a flex container */
        align-items: center;
    }
    nav ul.left li {
        margin: 0;
        padding: 0;
    }
    nav .waves-effect.waves-light.btn {
      background-color: #3f51b5; /* Slightly lighter blue */
      height: 36px; /* Standard button height */
      line-height: 36px; /* Match height for vertical alignment */
      padding: 0 15px; /* Adjust padding */
    }
    nav .waves-effect.waves-light.btn .material-icons {
        line-height: 36px; /* Align icon vertically */
    }

    /* Main Container */
    .container {
      background-color: #fff;
      padding: 30px;
      border-radius: 12px; /* More rounded corners */
      box-shadow: 0 6px 30px rgba(0,0,0,0.08); /* Softer, deeper shadow */
      margin-top: 40px;
      margin-bottom: 40px;
      max-width: 1200px; /* Limit max width for readability */
      /* Center the container */
      margin-left: auto;
      margin-right: auto;
    }

    h4 {
      color: #333;
      margin-bottom: 30px; /* More space below heading */
      font-weight: 700; /* Bolder */
      border-bottom: 2px solid #e0e0e0; /* Subtle separator */
      padding-bottom: 15px;
    }

    /* Input Field RTL adjustments (already good, small tweaks) */
    .input-field label { right: 0.75rem; left: auto; }
    .input-field label:not(.label-icon).active {
        -webkit-transform: translateY(-14px) scale(0.8);
        transform: translateY(-14px) scale(0.8);
        right: 0.75rem !important;
        left: auto !important;
    }
    .input-field .prefix { right: 0.75rem; left: auto; }
    .input-field input:focus + label { right: 0.75rem !important; left: auto !important; }
    .input-field input[type=number]:not(.browser-default):focus:not([readonly]) + label,
    .input-field input[type=tel]:not(.browser-default):focus:not([readonly]) + label,
    .input-field input[type=text]:not(.browser-default):focus:not([readonly]) + label {
        color: #2196f3;
    }
    .input-field input[type=number]:not(.browser-default):focus:not([readonly]),
    .input-field input[type=tel]:not(.browser-default):focus:not([readonly]),
    .input-field input[type=text]:not(.browser-default):focus:not([readonly]) {
        border-bottom: 1px solid #2196f3;
        box-shadow: 0 1px 0 0 #2196f3;
    }
    .select-wrapper input.select-dropdown {
        text-align: right;
        padding-right: 0.75rem !important;
        padding-left: 3rem !important;
    }
    .caret { left: 0.75rem !important; right: auto !important; }
    .dropdown-content li>a, .dropdown-content li>span { text-align: right; }

    /* Button Grouping */
    .button-group {
        display: flex;
        justify-content: flex-end; /* Align buttons to the right in RTL */
        gap: 10px;
        margin-top: 20px;
    }
    .button-group-form {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 30px; /* More space for form buttons */
    }

    /* Main Navigation Buttons */
    .main-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 20px; /* Space between buttons */
        margin-bottom: 40px; /* More space below main buttons */
        padding: 20px;
        background-color: #e8eaf6; /* Lighter blue background for main buttons section */
        border-radius: 8px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        justify-items: center; /* Center items within their grid cells */
    }
    .main-buttons button {
        height: 80px; /* Taller buttons */
        font-size: 1.1em;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px; /* Space between icon and text */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        width: 100%; 
        max-width: 280px; /* Limit max width for readability and prevent excessive stretching */
    }
    .main-buttons button:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .main-buttons button .material-icons {
        font-size: 2em; /* Larger icons */
    }

    /* Section Styles */
    .form-section {
        background-color: #ffffff; /* White background for forms */
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); /* Lighter shadow */
        margin-top: 40px; /* More margin from top */
        border: 1px solid #e0e0e0; /* Subtle border */
    }
    .form-section h5 {
        color: #3f51b5; /* Materialize primary blue for section titles */
        margin-bottom: 25px;
        font-weight: 500;
        border-bottom: 1px solid #eeeeee;
        padding-bottom: 10px;
    }

    /* Schedule Input Group */
    .schedule-input-group {
        border: 1px dashed #bdbdbd; /* Slightly darker dash */
        padding: 20px; /* More padding */
        margin-bottom: 20px; /* More margin */
        border-radius: 8px;
        background-color: #fdfdfd; /* Very light background */
    }
    .schedule-input-group h6 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #555;
        font-weight: 500;
        font-size: 1.1em;
    }

    /* Table Styling (General for both renewal and manage) */
    table {
      width: 100%; /* Keep width 100% to fill container */
      border-collapse: collapse;
      margin-top: 30px;
      background-color: #ffffff;
      border-radius: 8px;
    }
    th, td {
      padding: 15px 20px; /* More padding */
      text-align: right;
      border-bottom: 1px solid #e0e0e0;
      /* white-space: normal; - سيتم تطبيقه في media queries للهواتف */
    }
    th {
      background-color: #f5f5f5; /* Lighter header background */
      font-weight: 600;
      color: #424242;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:hover {
      background-color: #fafafa; /* Subtle hover effect */
    }
    
    /* Container for responsive tables to ensure horizontal scroll */
    .table-scroll-wrapper {
      /* Removed overflow-x: auto from here, will be applied in media queries */
      -webkit-overflow-scrolling: touch; /* For smooth scrolling on iOS devices */
      margin-bottom: 20px; /* Add some space below the table if it scrolls */
      padding-bottom: 10px; /* Ensure scrollbar is visible and not hidden */
    }

    /* Status Tags */
    .status-tag {
      padding: 8px 15px; /* Larger padding */
      border-radius: 25px; /* More rounded */
      font-weight: 600;
      color: white;
      display: inline-block;
      min-width: 100px; /* Consistent width */
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Softer shadow */
      text-shadow: 0 1px 1px rgba(0,0,0,0.2); /* Subtle text shadow */
    }
    /* Colors remain same for status */
    .status-مطلوب-التجديد { background-color: #ffb300; } /* Amber */
    .status-تم-التجديد { background-color: #43a047; } /* Green */
    .status-تجاوز-الحد { background-color: #d32f2f; } /* Red */
    .status-لا-يوجد-حضور { background-color: #757575; } /* Grey */
    .status-غير-محدد, .status- { background-color: #1976d2; } /* Blue */

    /* Actions Cell - Default for larger screens */
    .actions-cell button {
        margin-right: 5px; /* Space between action buttons (RTL) */
        margin-left: 0;
        display: inline-flex; /* Use inline-flex for icon-only buttons */
        align-items: center;
        justify-content: center;
        width: 36px; /* Fixed width for icon button */
        height: 36px; /* Fixed height for icon button */
        padding: 0; /* No padding needed for icon-only button */
        line-height: 1; /* Adjust line height */
    }
    .actions-cell button .material-icons {
        font-size: 1.5em; /* Icon size for standard button */
    }
    .actions-cell {
        display: flex;
        justify-content: flex-start; /* Align action buttons to left in RTL */
        gap: 8px;
        flex-wrap: nowrap; /* Prevent wrapping by default */
    }

    /* Filter Section */
    .filter-section {
        display: flex;
        align-items: flex-end;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }
    .filter-section .input-field {
        flex-grow: 1; /* Allow input to grow */
        margin-bottom: 0; /* Remove default margin */
    }
    .filter-section button {
        white-space: nowrap; /* Prevent button text from wrapping */
    }

    /* Time Selection Modal */
    .time-selection-modal {
        padding: 35px; /* More padding */
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.15); /* Stronger shadow */
        max-width: 600px; /* Slightly wider modal */
    }
    .time-selection-modal h3 {
        margin-top: 0;
        margin-bottom: 25px;
        font-weight: 700;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    .slots-section {
        margin-top: 25px;
        padding: 20px;
        border-radius: 8px;
        background-color: #f9f9f9;
        box-shadow: 0 1px 5px rgba(0,0,0,0.05); /* Subtle shadow for sections */
        border: 1px solid #f0f0f0;
    }
    .slots-section h4 {
        font-size: 1.1em;
        margin-bottom: 15px;
        color: #555;
        font-weight: 600;
        border-bottom: none; /* No border for sub-headers */
        padding-bottom: 0;
    }
    .time-slots-grid {
        display: grid; /* Use grid for better alignment */
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Responsive columns */
        gap: 10px; /* More space */
        margin-top: 15px;
        direction: ltr; /* Ensure times are left-to-right */
        justify-content: flex-start;
    }
    .time-slot-chip {
        padding: 10px 15px; /* Larger padding */
        border-radius: 25px; /* More rounded */
        font-size: 0.95em;
        transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.1s ease;
        text-align: center;
        white-space: nowrap; /* Prevent wrapping */
    }
    .time-slot-chip:hover:not(.disabled) {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .time-slot-chip.selected {
        background-color: #2196f3; /* Blue */
        color: white;
        border-color: #2196f3;
        box-shadow: 0 2px 5px rgba(33,150,243,0.3);
    }
    .time-slot-chip.disabled {
        background-color: #e0e0e0;
        color: #9e9e9e;
        cursor: not-allowed;
        border-color: #ccc;
        opacity: 0.7;
    }
    .no-slots-message {
        text-align: center;
        color: #888;
        padding: 20px;
        font-style: italic;
    }
    .modal-actions {
        margin-top: 30px; /* More space */
    }

    /* Teacher Schedules Update Page */
    #updateSchedulesContainer .days-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Larger day cards */
        gap: 20px;
    }
    #updateSchedulesContainer .day-card {
        background-color: #e3f2fd; /* Light blue */
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.1); /* Slightly more prominent shadow */
        transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
    }
    #updateSchedulesContainer .day-card:hover {
        background-color: #bbdefb;
        transform: translateY(-2px);
        box-shadow: 0 5px 12px rgba(0,0,0,0.15);
    }
    #updateSchedulesContainer .day-card h6 {
        font-size: 1.3em; /* Larger day name */
        color: #1a237e;
        margin-bottom: 15px;
    }
    #updateSchedulesContainer .day-card p {
        font-size: 0.95em;
        color: #424242;
        margin-bottom: 10px;
    }
    #updateSchedulesContainer .day-card span.chip {
        margin: 5px;
        font-size: 0.85em;
        background-color: #ffffff;
        color: #333;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Summary Page Styles */
    .summary-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Flexible columns for summary cards */
        gap: 25px; /* Spacing between summary cards */
        margin-top: 30px;
    }
    .summary-card-item {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.07);
        padding: 25px;
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid #e0e0e0;
    }
    .summary-card-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    .summary-card-item .material-icons {
        font-size: 3.5em; /* Large icon size */
        margin-bottom: 15px;
    }
    .summary-card-item h6 {
        font-size: 1.5em; /* Larger title for statistic */
        font-weight: 700;
        color: #333;
        margin-top: 0;
        margin-bottom: 10px;
    }
    .summary-card-item p {
        font-size: 1.1em;
        color: #555;
        margin-bottom: 0;
    }
    .summary-card-item .data-value {
        font-size: 1.8em; /* Very large number */
        font-weight: 800;
        color: #2196f3; /* Primary blue for numbers */
        display: block; /* Make it a block element for spacing */
        margin-top: 5px;
    }
    /* Specific colors for summary cards */
    .summary-card-total-students .material-icons { color: #4CAF50; /* Green */ }
    .summary-card-total-students .data-value { color: #4CAF50; }
    
    .summary-card-renewal-needed .material-icons { color: #FFC107; /* Amber */ }
    .summary-card-renewal-needed .data-value { color: #FFC107; }

    .summary-card-payments .material-icons { color: #2196F3; /* Blue */ }
    .summary-card-payments .data-value { color: #2196F3; }
    
    .summary-card-teachers .material-icons { color: #8BC34A; /* Light Green */ }
    .summary-card-teachers .data-value { color: #8BC34A; }

    .summary-card-slots .material-icons { color: #9C27B0; /* Purple */ }
    .summary-card-slots .data-value { color: #9C27B0; }


    /* Responsive Adjustments */
    @media (max-width: 992px) {
        /* Navbar Adjustments for medium screens */
        nav .brand-logo {
            font-size: 1.5rem;
            text-align: right; /* Revert to right alignment for RTL */
            flex-grow: 0; /* Don't stretch */
        }
        nav .nav-wrapper {
            justify-content: flex-end; /* Push content to the right (RTL) */
        }
        nav ul.left {
            position: absolute; /* Revert to absolute for exact left placement */
            left: 20px; /* Keep to the left */
            order: 0; /* Reset order */
        }

        .main-buttons {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
        .main-buttons button {
            height: 70px;
            font-size: 1em;
            max-width: 100%; /* Allow buttons to stretch if needed */
        }
        .filter-section {
            flex-direction: column;
            align-items: stretch;
        }
        .filter-section button {
            width: 100%;
        }
        
        /* Table adjustments for medium screens - Allow content to wrap */
        table th,
        table td {
            padding: 10px 15px; /* Less padding on medium screens */
            font-size: 0.95em; /* Slightly smaller font */
            white-space: normal; /* Allow content to wrap */
        }
        /* Actions cell adjustments for medium screens */
        .actions-cell {
            flex-wrap: wrap; /* Allow wrapping on medium screens */
            justify-content: center; /* Center buttons if wrapped */
            gap: 5px;
        }
        .actions-cell button {
            /* Icon-only button adjustments for medium screens */
            width: 32px; /* Slightly smaller fixed width */
            height: 32px; /* Slightly smaller fixed height */
        }
        .actions-cell button .material-icons {
            font-size: 1.3em; /* Adjust icon size */
        }

        /* Summary page for medium screens */
        .summary-card-item h6 {
            font-size: 1.3em;
        }
        .summary-card-item .data-value {
            font-size: 1.6em;
        }

    }
    @media (max-width: 600px) {
        .container {
            padding: 15px; /* Less padding on very small screens */
            margin-top: 15px;
            margin-bottom: 15px;
        }
        h4 {
            font-size: 1.4em; /* Smaller main heading */
            margin-bottom: 20px;
        }
        .main-buttons {
            grid-template-columns: 1fr; /* Single column on small phones */
            gap: 15px;
            padding: 15px;
        }
        .main-buttons button {
            height: 55px; /* Smaller button height */
            font-size: 0.9em;
            max-width: 100%; /* Ensure fills column */
        }
        .form-section {
            padding: 15px;
            margin-top: 25px;
        }
        .form-section h5 {
            font-size: 1.2em; /* Smaller section heading */
            margin-bottom: 15px;
        }
        .input-field label {
            font-size: 0.9em; /* Smaller label font */
        }
        .input-field input, .select-wrapper input.select-dropdown {
            font-size: 0.95em; /* Smaller input font */
        }
        .schedule-input-group {
            padding: 15px;
            margin-bottom: 15px;
        }
        .schedule-input-group h6 {
            font-size: 1em;
        }
        
        /* Table adjustments for very small screens - Allow content to wrap */
        table {
            min-width: unset; /* Remove min-width to allow full responsiveness */
            width: 100%; /* Ensure it tries to fit 100% */
        }
        table th,
        table td {
            padding: 8px 10px; /* Even less padding */
            font-size: 0.8em; /* Even smaller font */
            white-space: normal; /* Crucial: Allow content to wrap */
        }
        .status-tag {
            padding: 5px 8px; /* Smaller status tags */
            min-width: 70px;
            font-size: 0.75em;
        }
        .actions-cell button {
            /* Icon-only button adjustments for very small screens */
            width: 30px; /* Smallest fixed width */
            height: 30px; /* Smallest fixed height */
        }
        .actions-cell button .material-icons {
            font-size: 1.2em; /* Adjust icon size */
        }


        .time-slots-grid {
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); /* Smaller chips */
            gap: 8px;
        }
        .time-slot-chip {
            padding: 8px 10px;
            font-size: 0.85em;
        }
        .modal-content.time-selection-modal {
            padding: 20px;
        }
        .modal-actions button {
            font-size: 0.9em;
            padding: 0 10px;
        }
        /* Navbar specific for very small screens */
        nav .brand-logo {
            font-size: 1.3rem; /* Even smaller on very small screens */
            text-align: center; /* Keep centered */
            width: 100%; /* Occupy full width to center effectively */
            position: absolute; /* Revert to absolute for centering */
            left: 0;
            right: 0;
        }
        nav ul.left {
            display: none; /* Hide the home button on very small screens if it interferes */
        }
        /* Make sure search input is full width in filter section */
        .filter-section .input-field.filter-input {
            width: 100%;
        }

        /* Summary page for very small screens */
        .summary-cards-grid {
            grid-template-columns: 1fr; /* Single column on very small screens */
            gap: 15px;
        }
        .summary-card-item {
            padding: 20px;
        }
        .summary-card-item .material-icons {
            font-size: 3em;
        }
        .summary-card-item h6 {
            font-size: 1.2em;
        }
        .summary-card-item .data-value {
            font-size: 1.5em;
        }
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-wrapper container">
      <a href="#" class="brand-logo">إدارة أكاديمية رفاق</a>
      <ul id="nav-mobile" class="left hide-on-med-and-down">
        <li><button class="btn waves-effect waves-light blue lighten-1" onclick="goHome()">
            <i class="material-icons right">home</i>الرئيسية
        </button></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <h4 class="center-align">لوحة تحكم المشرف</h4>

    <div id="mainButtons" class="main-buttons">
        <button class="btn waves-effect waves-light green darken-1" onclick="showAddStudentForm()">
            <i class="material-icons right">person_add</i>إضافة طالب جديد
        </button>
        <button class="btn waves-effect waves-light blue darken-1" onclick="showRenewalList()">
            <i class="material-icons right">view_list</i>عرض التجديدات
        </button>
        <button class="btn waves-effect waves-light orange darken-1" onclick="showEditDeleteStudentForm()">
            <i class="material-icons right">edit</i>تعديل / حذف طالب
        </button>
        <button class="btn waves-effect waves-light purple darken-1" onclick="showUpdateSchedulesForm()">
            <i class="material-icons right">schedule</i>تحديث مواعيد المعلمين
        </button>
        <button class="btn waves-effect waves-light teal darken-1" onclick="showManageStudentsList()">
            <i class="material-icons right">people</i>إدارة الطلاب
        </button>
        <button class="btn waves-effect waves-light deep-purple darken-1" onclick="showSummaryPage()">
            <i class="material-icons right">dashboard</i>ملخص الأكاديمية
        </button>
    </div>

    <div id="studentListContainer" class="form-section">
        <h5 class="center-align">قائمة تجديد الطلاب</h5>
        <div class="filter-section">
            <div class="input-field filter-input">
                <i class="material-icons prefix">search</i>
                <input type="text" id="studentSearch" onkeyup="filterStudents()" class="validate">
                <label for="studentSearch">ابحث بالمعرف أو الاسم أو النظام</label>
            </div>
            <button class="btn waves-effect waves-light blue lighten-1" onclick="loadStudents()">
                <i class="material-icons right">refresh</i>تحديث البيانات
            </button>
            <button class="btn waves-effect waves-light grey lighten-1" type="button" onclick="goHome()">
                <i class="material-icons right">home</i>الرئيسية
            </button>
        </div>
        <div id="studentList">
          <p class="center-align">جاري تحميل بيانات الطلاب...</p>
        </div>
    </div>

    <div id="addStudentForm" class="row form-section">
        <h5 class="center-align">إضافة طالب جديد</h5>
        <form class="col s12" onsubmit="handleNewStudentSubmit(event)">
            <div class="row">
                <div class="input-field col s12 m6">
                    <input id="new_student_name" type="text" class="validate" required>
                    <label for="new_student_name">الاسم</label>
                </div>
                <div class="input-field col s12 m6">
                    <input id="new_student_age" type="number" class="validate">
                    <label for="new_student_age">السن</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12 m6">
                    <input id="new_student_number" type="tel" class="validate">
                    <label for="new_student_number">رقم التليفون</label>
                </div>
                <div class="input-field col s12 m6">
                    <select id="new_subscription_type" required>
                        <option value="" disabled selected>اختر نوع الاشتراك</option>
                        <option value="فردي صغار">فردي صغار</option>
                        <option value="فردي كبار">فردي كبار</option>
                        <option value="جماعي">جماعي</option>
                        <option value="نور بيان">نور بيان</option>
                    </select>
                    <label>نوع الاشتراك</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <select id="new_system_type" required onchange="updateScheduleFields('add')">
                        <option value="" disabled selected>اختر النظام</option>
                        <option value="حلقة / اسبوع / 30 دقيقة">حلقة / اسبوع / 30 دقيقة</option>
                        <option value="حلقتين / اسبوع / 30 دقيقة">حلقتين / اسبوع / 30 دقيقة</option>
                        <option value="3 حلقات / اسبوع / 30 دقيقة">3 حلقات / اسبوع / 30 دقيقة</option>
                        <option value="حلقتين / اسبوع / 60 دقيقة">حلقتين / اسبوع / 60 دقيقة</option>
                        <option value="حلقة / اسبوع / 60 دقيقة">حلقة / اسبوع / 60 دقيقة</option>
                        <option value="يومياً">يومياً</option>
                        <option value="حلقتين / اسبوع / 45 دقيقة">حلقتين / اسبوع / 45 دقيقة</option>
                        <option value="3 حلقات / اسبوع / 45 دقيقة">3 حلقات / اسبوع / 45 دقيقة</option>
                        <option value="4 حلقات / اسبوع / 30 دقيقة">4 حلقات / اسبوع / 30 دقيقة</option>
                        <option value="6 حلقات / اسبوع / 30 دقيقة">6 حلقات / اسبوع / 30 دقيقة</option>
                    </select>
                    <label>النظام</label>
                </div>
            </div>

            <div class="row">
                <div class="input-field col s12">
                    <select id="new_teacher_name" required onchange="updateScheduleFields('add')">
                        <option value="" disabled selected>اختر المعلم الأساسي للطالب</option>
                    </select>
                    <label>المعلم الأساسي</label>
                </div>
            </div>

            <div id="addScheduleFieldsContainer">
                </div>

            <div class="button-group-form">
                <button class="btn waves-effect waves-light blue" type="submit">
                    <i class="material-icons right">send</i>إضافة الطالب
                </button>
                <button class="btn waves-effect waves-light red lighten-1" type="button" onclick="goHome()">
                    <i class="material-icons right">cancel</i>إلغاء
                </button>
            </div>
        </form>
    </div>

    <div id="editDeleteStudentContainer" class="row form-section">
        <h5 class="center-align">تعديل / حذف طالب</h5>
        <div class="row">
            <div class="input-field col s10">
                <i class="material-icons prefix">search</i>
                <input type="text" id="edit_student_query" class="validate">
                <label for="edit_student_query">ابحث بالمعرف أو رقم الهاتف</label>
            </div>
            <div class="col s2">
                <button class="btn waves-effect waves-light blue" style="width: 100%;" onclick="searchStudentAndDisplay()">
                    <i class="material-icons right">search</i>بحث
                </button>
            </div>
        </div>

        <div id="editStudentDetails" style="display: none;">
            <form class="col s12" onsubmit="handleUpdateStudent(event)">
                <input type="hidden" id="edit_student_id">
                <input type="hidden" id="edit_student_master_row">
                <input type="hidden" id="edit_student_subscription_date"> 
                <div class="row student-details-form">
                    <div class="input-field col s12 m6">
                        <input id="edit_student_name" type="text" class="validate" required>
                        <label for="edit_student_name">الاسم</label>
                    </div>
                    <div class="input-field col s12 m6">
                        <input id="edit_student_age" type="number" class="validate">
                        <label for="edit_student_age">السن</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12 m6">
                        <input id="edit_student_number" type="tel" class="validate">
                        <label for="edit_student_number">رقم التليفون</label>
                    </div>
                    <div class="input-field col s12 m6">
                        <select id="edit_subscription_type" required>
                            <option value="" disabled selected>اختر نوع الاشتراك</option>
                            <option value="فردي صغار">فردي صغار</option>
                            <option value="فردي كبار">فردي كبار</option>
                            <option value="جماعي">جماعي</option>
                            <option value="نور بيان">نور بيان</option>
                        </select>
                        <label>نوع الاشتراك</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <select id="edit_system_type" required onchange="updateScheduleFields('edit')">
                            <option value="" disabled selected>اختر النظام</option>
                            <option value="حلقة / اسبوع / 30 دقيقة">حلقة / اسبوع / 30 دقيقة</option>
                            <option value="حلقتين / اسبوع / 30 دقيقة">حلقتين / اسبوع / 30 دقيقة</option>
                            <option value="3 حلقات / اسبوع / 30 دقيقة">3 حلقات / اسبوع / 30 دقيقة</option>
                            <option value="حلقتين / اسبوع / 60 دقيقة">حلقتين / اسبوع / 60 دقيقة</option>
                            <option value="حلقة / اسبوع / 60 دقيقة">حلقة / اسبوع / 60 دقيقة</option>
                            <option value="يومياً">يومياً</option>
                            <option value="حلقتين / اسبوع / 45 دقيقة">حلقتين / اسبوع / 45 دقيقة</option>
                            <option value="3 حلقات / اسبوع / 45 دقيقة">3 حلقات / اسبوع / 45 دقيقة</option>
                            <option value="4 حلقات / اسبوع / 30 دقيقة">4 حلقات / اسبوع / 30 دقيقة</option>
                            <option value="6 حلقات / اسبوع / 30 دقيقة">6 حلقات / اسبوع / 30 دقيقة</option>
                        </select>
                        <label>النظام</label>
                    </div>
                </div>

                <div class="row">
                    <div class="input-field col s12">
                        <select id="edit_teacher_name" required onchange="updateScheduleFields('edit')">
                            <option value="" disabled selected>اختر المعلم الأساسي للطالب</option>
                        </select>
                        <label>المعلم الأساسي</label>
                    </div>
                </div>

                <div id="editScheduleFieldsContainer">
                    </div>

                <div class="button-group-form">
                    <button class="btn waves-effect waves-light blue" type="submit">
                        <i class="material-icons right">save</i>حفظ التعديلات
                    </button>
                    <button class="btn waves-effect waves-light red darken-2" type="button" onclick="promptDeleteStudent()">
                        <i class="material-icons right">delete_forever</i>حذف الطالب
                    </button>
                    <button class="btn waves-effect waves-light grey lighten-1" type="button" onclick="goHome()">
                        <i class="material-icons right">cancel</i>إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="updateSchedulesContainer" class="row form-section">
        <h5 class="center-align">تحديث مواعيد المعلمين المتاحة</h5>
        <div class="row teacher-selection-section">
            <div class="input-field col s12">
                <select id="update_teacher_name" required onchange="displayTeacherSchedulesForUpdate()">
                    <option value="" disabled selected>اختر المعلم لتحديث مواعيده</option>
                </select>
                <label>المعلم</label>
            </div>
        </div>
        
        <div id="teacherSchedulesDisplay" style="display: none;">
            <div class="days-grid">
                </div>
            <div class="button-group-form">
                <button class="btn waves-effect waves-light grey lighten-1" type="button" onclick="goHome()">
                    <i class="material-icons right">cancel</i>إلغاء
                </button>
            </div>
        </div>
    </div>

    <div id="manageStudentsContainer" class="row form-section">
        <h5 class="center-align">إدارة الطلاب (تعديل / حذف شامل)</h5>
        <div class="filter-section">
            <div class="input-field filter-input">
                <i class="material-icons prefix">search</i>
                <input type="text" id="manage_student_search" onkeyup="filterManageStudents()" class="validate">
                <label for="manage_student_search">ابحث بالمعرف أو الاسم أو الرقم</label>
            </div>
            <button class="btn waves-effect waves-light blue lighten-1" onclick="loadManageStudents()">
                <i class="material-icons right">refresh</i>تحديث القائمة
            </button>
            <button class="btn waves-effect waves-light grey lighten-1" type="button" onclick="goHome()">
                <i class="material-icons right">home</i>الرئيسية
            </button>
        </div>

        <div id="manageStudentList">
            <p class="center-align">جاري تحميل بيانات الطلاب...</p>
        </div>
    </div>

    <div id="summaryPageContainer" class="row form-section">
        <h5 class="center-align">ملخص شامل للأكاديمية</h5>
        <div class="summary-cards-grid">
            <div class="summary-card-item summary-card-total-students">
                <i class="material-icons">people</i>
                <h6>إجمالي الطلاب</h6>
                <span class="data-value" id="totalStudentsSummary">--</span>
                <p>طلاب نشطون: <span id="activeStudentsSummary">--</span></p>
            </div>
            <div class="summary-card-item summary-card-renewal-needed">
                <i class="material-icons">refresh</i>
                <h6>يحتاجون للتجديد</h6>
                <span class="data-value" id="renewalNeededSummary">--</span>
                <p>تجاوزوا الحد: <span id="overdueRenewalSummary">--</span></p>
            </div>
            <div class="summary-card-item summary-card-payments">
                <i class="material-icons">attach_money</i>
                <h6>دفعات هذا الشهر</h6>
                <span class="data-value" id="monthlyPaymentsSummary">--</span>
                <p>إجمالي دفعات العام: <span id="yearlyPaymentsSummary">--</span></p>
            </div>
            <div class="summary-card-item summary-card-teachers">
                <i class="material-icons">group</i>
                <h6>إجمالي المعلمين</h6>
                <span class="data-value" id="totalTeachersSummary">--</span>
                <p>معلمين نشطون: <span id="activeTeachersSummary">--</span></p>
            </div>
            <div class="summary-card-item summary-card-slots">
                <i class="material-icons">event_available</i>
                <h6>مواعيد متاحة</h6>
                <span class="data-value" id="availableSlotsSummary">--</span>
                <p>مواعيد محجوزة: <span id="bookedSlotsSummary">--</span></p>
            </div>
        </div>

        <div class="button-group-form">
            <button class="btn waves-effect waves-light blue lighten-1" onclick="loadSummaryData()">
                <i class="material-icons right">refresh</i>تحديث الملخص
            </button>
            <button class="btn waves-effect waves-light grey lighten-1" type="button" onclick="goHome()">
                <i class="material-icons right">home</i>الرئيسية
            </button>
        </div>
    </div>


  </div> <div id="initialTeacherDataElement" style="display:none;"><?!= initialTeacherDataJson ?></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    // -----------------------------------------------------------
    // الدوال الأساسية لإدارة عرض الأقسام الرئيسية (تم نقلها للأعلى لضمان التعريف)
    // -----------------------------------------------------------
    function goHome() {
        document.getElementById('mainButtons').style.display = 'grid'; // Changed to grid
        document.getElementById('studentListContainer').style.display = 'none';
        document.getElementById('addStudentForm').style.display = 'none';
        document.getElementById('editDeleteStudentContainer').style.display = 'none';
        document.getElementById('updateSchedulesContainer').style.display = 'none';
        document.getElementById('manageStudentsContainer').style.display = 'none';
        document.getElementById('summaryPageContainer').style.display = 'none'; // ***** أضف هذا السطر *****
        
        // إعادة ضبط الفورمات عند العودة للصفحة الرئيسية
        const addForm = document.getElementById('addStudentForm').querySelector('form');
        if (addForm) addForm.reset();
        document.getElementById('addScheduleFieldsContainer').innerHTML = '';

        const editForm = document.getElementById('editDeleteStudentContainer').querySelector('form');
        if (editForm) editForm.reset();
        document.getElementById('editScheduleFieldsContainer').innerHTML = '';
        document.getElementById('editStudentDetails').style.display = 'none';
        document.getElementById('edit_student_query').value = '';

        const updateForm = document.getElementById('updateSchedulesContainer').querySelector('form');
        if (updateForm) updateForm.reset();
        document.getElementById('teacherSchedulesDisplay').style.display = 'none';
        document.querySelector('#updateSchedulesContainer .days-grid').innerHTML = '';
        
        const manageSearch = document.getElementById('manage_student_search');
        if (manageSearch) manageSearch.value = '';
        const manageList = document.getElementById('manageStudentList');
        if (manageList) manageList.innerHTML = '<p class="center-align">جاري تحميل بيانات الطلاب...</p>';

        // إعادة تعيين بيانات الملخص عند العودة للصفحة الرئيسية
        summaryData = {};
        displaySummaryData(); // لعرض "--" مرة أخرى

        M.updateTextFields();
        M.FormSelect.init(document.getElementById('new_subscription_type'));
        M.FormSelect.init(document.getElementById('new_system_type'));
        M.FormSelect.init(document.getElementById('new_teacher_name'));
        M.FormSelect.init(document.getElementById('edit_subscription_type'));
        M.FormSelect.init(document.getElementById('edit_system_type'));
        M.FormSelect.init(document.getElementById('edit_teacher_name'));
        M.FormSelect.init(document.getElementById('update_teacher_name'));
    }

    function showAddStudentForm() {
        document.getElementById('mainButtons').style.display = 'none';
        document.getElementById('studentListContainer').style.display = 'none';
        document.getElementById('addStudentForm').style.display = 'none';
        document.getElementById('editDeleteStudentContainer').style.display = 'none';
        document.getElementById('updateSchedulesContainer').style.display = 'none';
        document.getElementById('manageStudentsContainer').style.display = 'none';
        document.getElementById('summaryPageContainer').style.display = 'none';
        document.getElementById('addStudentForm').style.display = 'block';
        
        const addForm = document.getElementById('addStudentForm').querySelector('form');
        if (addForm) addForm.reset();
        document.getElementById('addScheduleFieldsContainer').innerHTML = '';
        M.updateTextFields();
        initializeTeacherDataForForms('add');
    }

    function showRenewalList() {
        document.getElementById('mainButtons').style.display = 'none';
        document.getElementById('addStudentForm').style.display = 'none';
        document.getElementById('editDeleteStudentContainer').style.display = 'none';
        document.getElementById('updateSchedulesContainer').style.display = 'none';
        document.getElementById('manageStudentsContainer').style.display = 'none';
        document.getElementById('summaryPageContainer').style.display = 'none';
        document.getElementById('studentListContainer').style.display = 'block';
        loadStudents();
        M.updateTextFields(); 
    }

    function showEditDeleteStudentForm() {
        document.getElementById('mainButtons').style.display = 'none';
        document.getElementById('studentListContainer').style.display = 'none';
        document.getElementById('addStudentForm').style.display = 'none';
        document.getElementById('updateSchedulesContainer').style.display = 'none';
        document.getElementById('manageStudentsContainer').style.display = 'none';
        document.getElementById('summaryPageContainer').style.display = 'none';
        document.getElementById('editDeleteStudentContainer').style.display = 'block';
        
        const editForm = document.getElementById('editDeleteStudentContainer').querySelector('form');
        if (editForm) editForm.reset();
        document.getElementById('editScheduleFieldsContainer').innerHTML = '';
        document.getElementById('editStudentDetails').style.display = 'none';
        document.getElementById('edit_student_query').value = '';
        M.updateTextFields();
        initializeTeacherDataForForms('edit');
    }

    function showUpdateSchedulesForm() {
        document.getElementById('mainButtons').style.display = 'none';
        document.getElementById('studentListContainer').style.display = 'none';
        document.getElementById('addStudentForm').style.display = 'none';
        document.getElementById('editDeleteStudentContainer').style.display = 'none';
        document.getElementById('manageStudentsContainer').style.display = 'none';
        document.getElementById('summaryPageContainer').style.display = 'none';
        document.getElementById('updateSchedulesContainer').style.display = 'block';

        const updateForm = document.getElementById('updateSchedulesContainer').querySelector('form');
        if (updateForm) updateForm.reset();
        document.getElementById('teacherSchedulesDisplay').style.display = 'none';
        document.querySelector('#updateSchedulesContainer .days-grid').innerHTML = '';
        M.updateTextFields();
        initializeTeacherDataForForms('update');
    }

    function showManageStudentsList() {
        document.getElementById('mainButtons').style.display = 'none';
        document.getElementById('studentListContainer').style.display = 'none';
        document.getElementById('addStudentForm').style.display = 'none';
        document.getElementById('editDeleteStudentContainer').style.display = 'none';
        document.getElementById('updateSchedulesContainer').style.display = 'none';
        document.getElementById('summaryPageContainer').style.display = 'none';
        document.getElementById('manageStudentsContainer').style.display = 'block';
        loadManageStudents();
        M.updateTextFields();
    }


    // ***** دالة جديدة لعرض صفحة الملخص *****
    function showSummaryPage() {
        document.getElementById('mainButtons').style.display = 'none';
        document.getElementById('studentListContainer').style.display = 'none';
        document.getElementById('addStudentForm').style.display = 'none';
        document.getElementById('editDeleteStudentContainer').style.display = 'none';
        document.getElementById('updateSchedulesContainer').style.display = 'none';
        document.getElementById('manageStudentsContainer').style.display = 'none';
        document.getElementById('summaryPageContainer').style.display = 'block'; // ***** أظهر صفحة الملخص *****
        loadSummaryData(); // قم بتحميل البيانات عند فتح الصفحة
    }

    // ***** دالة جديدة لتحميل وعرض بيانات الملخص *****
    function loadSummaryData() {
        // عرض حالة "جاري التحميل"
        document.getElementById('totalStudentsSummary').textContent = 'جاري...';
        document.getElementById('activeStudentsSummary').textContent = 'جاري...';
        document.getElementById('renewalNeededSummary').textContent = 'جاري...';
        document.getElementById('overdueRenewalSummary').textContent = 'جاري...';
        document.getElementById('monthlyPaymentsSummary').textContent = 'جاري...';
        document.getElementById('yearlyPaymentsSummary').textContent = 'جاري...';
        document.getElementById('totalTeachersSummary').textContent = 'جاري...'; // new
        document.getElementById('activeTeachersSummary').textContent = 'جاري...'; // new
        document.getElementById('availableSlotsSummary').textContent = 'جاري...'; // new
        document.getElementById('bookedSlotsSummary').textContent = 'جاري...'; // new

        M.toast({html: 'جاري جلب ملخص البيانات...', classes: 'blue lighten-1'});
        google.script.run
            .withSuccessHandler(function(jsonString) {
                try {
                    summaryData = JSON.parse(jsonString);
                    displaySummaryData(); // عرض البيانات في الواجهة
                    M.toast({html: 'تم تحديث الملخص بنجاح.', classes: 'green darken-1'});
                } catch (e) {
                    console.error("Failed to parse summary JSON:", e);
                    M.toast({html: `خطأ في تحليل بيانات الملخص: ${e.message}`, classes: 'red darken-3'});
                    // إعادة تعيين إلى -- في حالة الخطأ
                    document.getElementById('totalStudentsSummary').textContent = '--';
                    document.getElementById('activeStudentsSummary').textContent = '--';
                    document.getElementById('renewalNeededSummary').textContent = '--';
                    document.getElementById('overdueRenewalSummary').textContent = '--';
                    document.getElementById('monthlyPaymentsSummary').textContent = '--';
                    document.getElementById('yearlyPaymentsSummary').textContent = '--';
                    document.getElementById('totalTeachersSummary').textContent = '--'; // new
                    document.getElementById('activeTeachersSummary').textContent = '--'; // new
                    document.getElementById('availableSlotsSummary').textContent = '--'; // new
                    document.getElementById('bookedSlotsSummary').textContent = '--'; // new
                }
            })
            .withFailureHandler(onFailure)
            .getAcademySummary(); // *** هذه هي الدالة الجديدة التي ستحتاج لإنشائها في code.gs ***
    }

    // ***** دالة جديدة لعرض البيانات المحملة في الواجهة *****
    function displaySummaryData() {
        document.getElementById('totalStudentsSummary').textContent = summaryData.totalStudents !== undefined ? summaryData.totalStudents : '--';
        document.getElementById('activeStudentsSummary').textContent = summaryData.activeStudents !== undefined ? summaryData.activeStudents : '--';
        document.getElementById('renewalNeededSummary').textContent = summaryData.renewalNeeded !== undefined ? summaryData.renewalNeeded : '--';
        document.getElementById('overdueRenewalSummary').textContent = summaryData.overdueRenewal !== undefined ? summaryData.overdueRenewal : '--';
        document.getElementById('monthlyPaymentsSummary').textContent = summaryData.monthlyPayments !== undefined ? summaryData.monthlyPayments : '--';
        document.getElementById('yearlyPaymentsSummary').textContent = summaryData.yearlyPayments !== undefined ? summaryData.yearlyPayments : '--';
        document.getElementById('totalTeachersSummary').textContent = summaryData.totalTeachers !== undefined ? summaryData.totalTeachers : '--'; // new
        document.getElementById('activeTeachersSummary').textContent = summaryData.activeTeachers !== undefined ? summaryData.activeTeachers : '--'; // new
        document.getElementById('availableSlotsSummary').textContent = summaryData.availableSlots !== undefined ? summaryData.availableSlots : '--'; // new
        document.getElementById('bookedSlotsSummary').textContent = summaryData.bookedSlots !== undefined ? summaryData.bookedSlots : '--'; // new
    }

    // -----------------------------------------------------------
    // الدوال المساعدة العامة 
    // -----------------------------------------------------------

    // دالة لحساب عدد الحلقات بناءً على النظام (عدد الحصص الأسبوعية المطلوبة)
    function getMonthlyMaxClassesForForm(systemType) {
        if (!systemType) return 0;
        const normalizedSystem = systemType.toLowerCase();
        switch (normalizedSystem) {
            case "حلقة / اسبوع / 30 دقيقة":
            case "حلقة / اسبوع / 60 دقيقة":
                return 1; // حصة واحدة أسبوعياً
            case "حلقتين / اسبوع / 30 دقيقة":
            case "حلقتين / اسبوع / 60 دقيقة":
            case "حلقتين / اسبوع / 45 دقيقة":
                return 2; // حصتان أسبوعياً
            case "3 حلقات / اسبوع / 30 دقيقة":
            case "3 حلقات / اسبوع / 45 دقيقة":
                return 3; // ثلاث حصص أسبوعياً
            case "4 حلقات / اسبوع / 30 دقيقة":
                return 4; // أربع حصص أسبوعياً
            case "6 حلقات / اسبوع / 30 دقيقة":
            case "يومياً": // يُفترض أنها 6 أيام في الأسبوع
                return 6; // ست حصص أسبوعياً
            default:
                return 0;
        }
    }

    // دالة لمعالجة الأخطاء من Apps Script
    function onFailure(error) {
      console.error("An error occurred from Apps Script:", error.message);
      M.toast({html: `حدث خطأ: ${error.message}`, classes: 'red darken-3'});
      document.getElementById('studentListContainer').style.display = 'none';
      document.getElementById('addStudentForm').style.display = 'none';
      document.getElementById('editDeleteStudentContainer').style.display = 'none';
      document.getElementById('updateSchedulesContainer').style.display = 'none';
      document.getElementById('manageStudentsContainer').style.display = 'none';
      document.getElementById('summaryPageContainer').style.display = 'none';
      document.getElementById('mainButtons').style.display = 'grid'; // Changed to grid
    }


    // -----------------------------------------------------------
    // متغيرات عامة
    // -----------------------------------------------------------
    let allStudentsData = []; // لصفحة عرض التجديدات
    let allManageStudentsData = []; // لصفحة إدارة الطلاب (عرض الكل)
    let teachersNames = [];
    let availableSchedules = {}; // هذا سيحتوي على النصوص كما هي من الشيت
    let allSchedulesWithStatus = {}; // هذا سيحتوي على النصوص كما هي من الشيت
    let currentSelectedTeacherForUpdate = null;
    let summaryData = {}; // ***** متغير جديد لبيانات الملخص *****


    // هذا الكود سيقوم بقراءة البيانات الأولية من العنصر المخفي
    try {
        const initialDataElement = document.getElementById('initialTeacherDataElement');
        if (initialDataElement && initialDataElement.textContent) {
            const initialData = JSON.parse(initialDataElement.textContent);
            if (initialData && initialData.teacherNames && initialData.availableSchedules && initialData.allSchedulesWithStatus) {
                teachersNames = initialData.teacherNames;
                availableSchedules = initialData.availableSchedules;
                allSchedulesWithStatus = initialData.allSchedulesWithStatus;
                console.log("Using pre-loaded initial data from hidden element.");
            } else {
                 console.error("Initial data from hidden element was empty or invalid JSON.");
            }
        } else {
            console.error("Hidden element for initial data not found or empty.");
        }
    } catch (e) {
        console.error("Failed to parse initialTeacherData from hidden element:", e);
    }
    
    // ***** إزالة دالة formatTime12Hour من هنا *****
    // ***** إزالة دالة getTimeInMinutes من هنا *****

    // هذا المتغير سيظل يحتوي على الأوقات كنصوص، وهذا مقبول
    const possibleTimeSlots = [
        "9:00 ص", "9:30 ص", "10:00 ص", "10:30 ص", "11:00 ص", "11:30 ص", "12:00 م", "12:30 م",
        "1:00 م", "1:30 م", "2:00 م", "2:30 م", "3:00 م", "3:30 م", "4:00 م", "4:30 م",
        "5:00 م", "5:30 م", "6:00 م", "6:30 م", "7:00 م", "7:30 م", "8:00 م", "8:30 م",
        "9:00 م", "9:30 م", "10:00 م", "10:30 م"
    ]; 

    const daysOfWeek = ["السبت", "الاحد", "الاثنين", "الثلاثاء", "الاربعاء", "الخميس", "الجمعة"];
    let selectedSlotsInModal = []; 


    // -----------------------------------------------------------
    // دوال تحميل وعرض بيانات الطلاب (الجدول)
    // -----------------------------------------------------------

    function loadStudents() { // لصفحة عرض التجديدات
      const studentListDiv = document.getElementById('studentList');
      studentListDiv.innerHTML = '<p class="center-align">جاري تحميل بيانات الطلاب...</p>';
      google.script.run
        .withSuccessHandler(processAndDisplayStudents)
        .withFailureHandler(onFailure)
        .getStudentsRenewalStatus();
    }

    function processAndDisplayStudents(jsonString) { // لصفحة عرض التجديدات
      console.log("processAndDisplayStudents: Received JSON string:", jsonString);
      let students = [];
      try {
        students = JSON.parse(jsonString);
        console.log("processAndDisplayStudents: Parsed data:", students);
      } catch (e) {
        console.error("Failed to parse JSON string:", e);
        M.toast({html: `خطأ في تحليل البيانات: ${e.message}`, classes: 'red darken-3'});
        document.getElementById('studentList').innerHTML = '<p class="center-align" style="color: red;">خطأ في تنسيق البيانات المستلمة.</p>';
        return;
      }
      
      // ***** التعديل هنا: فلترة الطلاب الذين لا يحتاجون للتجديد *****
      // عرض جميع الطلاب الذين حالتهم ليست "تم التجديد" (أو فارغة)
      const filteredForRenewalDisplay = students.filter(student => {
          const status = student.renewalStatus || '';
          return status !== 'تم التجديد'; // أسهل وأشمل فلتر هنا
      });

      allStudentsData = students; // لصفحة عرض التجديدات (تظل البيانات الأصلية هنا للبحث)
      displayFilteredStudents(filteredForRenewalDisplay, 'renewal'); // نوع العرض: تجديد (فلترة عند العرض فقط)
      M.updateTextFields(); 
    }

    function loadManageStudents() {
        const manageStudentListDiv = document.getElementById('manageStudentList');
        manageStudentListDiv.innerHTML = '<p class="center-align">جاري تحميل بيانات الطلاب...</p>';
        google.script.run
            .withSuccessHandler(function(jsonString) {
                let students = [];
                try {
                    students = JSON.parse(jsonString);
                } catch (e) {
                    console.error("فشل في تحليل بيانات إدارة الطلاب:", e);
                    M.toast({html: `حدث خطأ في تحليل بيانات الطلاب: ${e.message}`, classes: 'red darken-3'});
                    return;
                }
                allManageStudentsData = students; // احتفظ بكل الطلاب هنا للبحث
                displayFilteredStudents(students, 'manage'); // عرض الطلاب في جدول إدارة الطلاب
            })
            .withFailureHandler(onFailure)
            .getStudentsRenewalStatus(); // نستخدم نفس الدالة لجلب بيانات الطلاب الأساسية
    }


    // دالة عرض الجدول المفلتر (لظهور الجدول بشكل تقليدي مع التمرير الأفقي)
    // viewMode: 'renewal' أو 'manage'
    function displayFilteredStudents(studentsToDisplay, viewMode) {
      const targetDiv = viewMode === 'renewal' ? document.getElementById('studentList') : document.getElementById('manageStudentList');
      targetDiv.innerHTML = '';

      if (!studentsToDisplay || studentsToDisplay.length === 0) {
        targetDiv.innerHTML = '<p class="center-align">لا يوجد طلاب لعرضهم.</p>';
        return;
      }

      let tableHtml = `
        <div class="table-scroll-wrapper"> <table class="striped highlight responsive-table">
            <thead>
              <tr>
                <th>المعرف</th>
                <th>الاسم</th>
                <th>السن</th>
                <th>الرقم</th>
                <th>النظام</th>
                ${viewMode === 'renewal' ? `
                <th>الحصص الحاضرة</th>
                <th>تاريخ آخر دفع</th>
                <th>المبلغ</th>
                <th>الحالة</th>
                ` : ''}
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody>
      `;

      studentsToDisplay.forEach(student => {
        const statusClass = student.renewalStatus ? `status-${student.renewalStatus.replace(/\s/g, '-')}` : 'status-غير-محدد';
        const lastPaymentDate = student.lastPaymentDate || '';

        tableHtml += `
          <tr>
            <td>${student.id || ''}</td>
            <td>${student.name || ''}</td>
            <td>${student.age || ''}</td>
            <td>${student.number || ''}</td>
            <td>${student.system || ''}</td>
            ${viewMode === 'renewal' ? `
            <td>${student.attendance || 0}</td>
            <td>${lastPaymentDate}</td>
            <td>${student.amount || 0}</td>
            <td><span class="status-tag ${statusClass}">${student.renewalStatus || 'غير محدد'}</span></td>
            ` : ''}
            <td class="actions-cell">
              ${viewMode === 'renewal' ? `
              <button class="btn waves-effect waves-light green" onclick="markAsRenewed('${student.id}', ${student.row})">
                <i class="material-icons">check</i>
              </button>
              <button class="btn waves-effect waves-light red" onclick="promptForManualRenewal('${student.id}', ${student.row})">
                <i class="material-icons">edit</i>
              </button>
              ` : `
              <button class="btn waves-effect waves-light orange" onclick="editStudentFromList('${student.id}')">
                <i class="material-icons">edit</i>
              </button>
              <button class="btn waves-effect waves-light red darken-2" onclick="promptDeleteStudentFromList('${student.id}', '${student.name}')">
                <i class="material-icons">delete</i>
              </button>
              `}
            </td>
          </tr>
        `;
      });

      tableHtml += `
            </tbody>
          </table>
      </div> `;

      targetDiv.innerHTML = tableHtml;
    }

    // دالة فلترة الطلاب لصفحة التجديدات (تفلتر بناءً على البيانات الموجودة حالياً في allStudentsData)
    function filterStudents() {
      const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
      // يتم فلترة allStudentsData ثم يتم تطبيق فلتر التجديد عند العرض
      const filteredForSearch = allStudentsData.filter(student => {
        return (student.id && student.id.toString().toLowerCase().includes(searchTerm)) ||
               (student.name && student.name.toString().toLowerCase().includes(searchTerm)) ||
               (student.system && student.system.toString().toLowerCase().includes(searchTerm));
      });
      // ثم نعيد تطبيق فلترة التجديد قبل العرض
      const filteredForRenewalDisplay = filteredForSearch.filter(student => {
          const status = student.renewalStatus || '';
          return status !== 'تم التجديد'; // نفس الفلتر يجب أن يطبق هنا أيضاً
      });
      displayFilteredStudents(filteredForRenewalDisplay, 'renewal');
    }

    // دالة فلترة الطلاب لصفحة إدارة الطلاب (تمت الإضافة)
    function filterManageStudents() {
        const searchTerm = document.getElementById('manage_student_search').value.toLowerCase();
        const filteredStudents = allManageStudentsData.filter(student => {
            return (student.id && student.id.toString().toLowerCase().includes(searchTerm)) ||
                   (student.name && student.name.toString().toLowerCase().includes(searchTerm)) ||
                   (student.number && student.number.toString().toLowerCase().includes(searchTerm));
        });
        displayFilteredStudents(filteredStudents, 'manage');
    }


    // دوال التجديد والدفع (كما هي)
    function markAsRenewed(studentId, row) {
      if (confirm(`هل أنت متأكد من تسجيل تجديد الطالب ${studentId} تلقائياً؟`)) {
        M.toast({html: `جاري تجديد الطالب ${studentId}...`, classes: 'blue lighten-1'});
        google.script.run
          .withSuccessHandler(function() {
            M.toast({html: `تم تجديد الطالب ${studentId} بنجاح.`, classes: 'green darken-1'});
            loadStudents(); // إعادة تحميل للطلاب المفلترين للتجديد
          })
          .withFailureHandler(onFailure)
          .handleRenewalFromWeb(studentId, row, 0);
      }
    }

    function promptForManualRenewal(studentId, row) {
      const amount = prompt(`أدخل المبلغ المدفوع للطالب ${studentId} لتسجيل دفعة يدوية:`);
      if (amount !== null && !isNaN(parseFloat(amount)) && parseFloat(amount) > 0) {
        M.toast({html: `جاري تسجيل دفعة ${amount} للطالب ${studentId}...`, classes: 'blue lighten-1'});
        google.script.run
          .withSuccessHandler(function() {
            M.toast({html: `تم تسجيل دفعة ${amount} للطالب ${studentId} بنجاح.`, classes: 'green darken-1'});
            loadStudents(); // إعادة تحميل للطلاب المفلترين للتجديد
          })
          .withFailureHandler(onFailure)
          .handleRenewalFromWeb(studentId, row, parseFloat(amount));
      } else if (amount !== null) {
        M.toast({html: 'المبلغ المدخل غير صالح. يرجى إدخال رقم موجب.', classes: 'red darken-1'});
      }
    }


    // -----------------------------------------------------------
    // دوال صفحة تحديث مواعيد المعلمين
    // -----------------------------------------------------------
    function displayTeacherSchedulesForUpdate() {
        const teacherName = document.getElementById('update_teacher_name').value;
        const teacherSchedulesDisplayDiv = document.getElementById('teacherSchedulesDisplay');
        const daysGrid = teacherSchedulesDisplayDiv.querySelector('.days-grid');
        daysGrid.innerHTML = '';

        if (!teacherName) {
            teacherSchedulesDisplayDiv.style.display = 'none';
            return;
        }

        currentSelectedTeacherForUpdate = teacherName;
        teacherSchedulesDisplayDiv.style.display = 'block';

        daysOfWeek.forEach(day => {
            const dayCard = document.createElement('div');
            dayCard.className = 'day-card';
            dayCard.onclick = () => showTimeSlotSelectionModal(day);

            const teacherDaySchedules = allSchedulesWithStatus[teacherName] && allSchedulesWithStatus[teacherName][day] ? 
                                        allSchedulesWithStatus[teacherName][day] : [];
            
            const availableCount = teacherDaySchedules.filter(slot => !slot.isBooked).length;
            const bookedCount = teacherDaySchedules.filter(slot => slot.isBooked).length;

            let timeChipsHtml = '';
            teacherDaySchedules.forEach(slot => {
                const slotClass = slot.isBooked ? 'red lighten-2' : 'green lighten-2';
                // ***** التعديل هنا: استخدام slot.timeSlot مباشرة *****
                timeChipsHtml += `<span class="new badge ${slotClass}" data-badge-caption="">${slot.timeSlot}</span>`;
            });


            dayCard.innerHTML = `
                <h6>${day}</h6>
                <p>متاح: ${availableCount} | محجوز: ${bookedCount}</p>
                <div style="text-align: left; padding: 5px; min-height: 40px;">${timeChipsHtml}</div>
            `;
            daysGrid.appendChild(dayCard);
        });
        M.updateTextFields();
    }

    function showTimeSlotSelectionModal(day) {
        const modalDiv = document.createElement('div');
        modalDiv.id = 'timeSlotModal';
        modalDiv.className = 'modal';
        modalDiv.innerHTML = `
            <div class="modal-content time-selection-modal">
                <h3>تحديد مواعيد يوم ${day}</h3>
                <div class="time-slots-modal-sections">
                    <div class="slots-section card">
                        <h4>مواعيد صباحية (09:00 ص - 03:00 م)</h4>
                        <div class="time-slots-grid"></div>
                    </div>
                    <div class="slots-section card" style="margin-top: 20px;">
                        <h4>مواعيد مسائية (03:00 م - 11:00 م)</h4>
                        <div class="time-slots-grid"></div>
                    </div>
                </div>
                <div class="modal-footer modal-actions">
                    <button type="button" class="btn blue waves-effect waves-light" id="saveTimeSlotsBtn">تأكيد المواعيد</button>
                    <button type="button" class="modal-close btn red waves-effect waves-light">إلغاء</button>
                </div>
            </div>
        `;
        document.body.appendChild(modalDiv);

        const instance = M.Modal.init(modalDiv, {
            onOpenEnd: () => {
                renderTimeSlotsInModal(day);
                document.getElementById('saveTimeSlotsBtn').onclick = () => handleSaveTimeSlots(day);
            },
            onCloseEnd: () => {
                modalDiv.remove();
            }
        });
        instance.open();
    }

    function renderTimeSlotsInModal(day) {
        const morningSlotsGrid = document.querySelector('#timeSlotModal .slots-section:first-child .time-slots-grid');
        const eveningSlotsGrid = document.querySelector('#timeSlotModal .slots-section:last-child .time-slots-grid');
        
        morningSlotsGrid.innerHTML = '';
        eveningSlotsGrid.innerHTML = '';

        const teacherAllSchedulesForDay = allSchedulesWithStatus[currentSelectedTeacherForUpdate] && allSchedulesWithStatus[currentSelectedTeacherForUpdate][day] ?
                                         allSchedulesWithStatus[currentSelectedTeacherForUpdate][day] : [];
        
        // selectedSlotsInModal يجب أن تحتوي الآن على النصوص كما هي
        selectedSlotsInModal = teacherAllSchedulesForDay.filter(slot => !slot.isBooked).map(slot => slot.timeSlot);

        const createTimeSlotButton = (slotString, isBooked, bookedByName = null) => {
            const isSelected = selectedSlotsInModal.includes(slotString);
            const isDisabled = isBooked;
            const button = document.createElement('button');
            button.type = 'button';
            button.className = `time-slot-chip ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}`;
            button.onclick = () => {
                if (!isDisabled) {
                    toggleSlotSelection(slotString);
                    button.className = `time-slot-chip ${selectedSlotsInModal.includes(slotString) ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}`;
                } else {
                     M.toast({html: `هذا الموعد محجوز بالفعل بواسطة ${bookedByName || 'طالب آخر'}. لا يمكن إلغاء تحديده.`, classes: 'red darken-3'});
                }
            };
            // ***** التعديل هنا: استخدام slotString مباشرة *****
            button.textContent = `${slotString} ${isBooked ? `(${bookedByName || 'محجوز'})` : ''}`;
            return button;
        };

        // ***** التعديل هنا: إزالة الفرز باستخدام getTimeInMinutes *****
        // يمكننا الحصول على جميع الأوقات الفريدة من possibleTimeSlots ومن الأوقات الفعلية للمعلم
        const allUniqueTimesToDisplay = Array.from(new Set(possibleTimeSlots.concat(teacherAllSchedulesForDay.map(s => s.timeSlot)))).filter(t => t);
        
        // يمكنك هنا فرز أبجدي إذا أردت ترتيباً ما، أو لا تفرز على الإطلاق
        // allUniqueTimesToDisplay.sort(); 

        allUniqueTimesToDisplay.forEach(slotString => {
            const slotData = teacherAllSchedulesForDay.find(s => s.timeSlot === slotString);
            
            // هذا الجزء يفترض أنك تريد الحفاظ على تقسيم صباحي/مسائي. بما أننا لا نحلل الوقت،
            // يجب أن نعتمد على ما إذا كان الوقت يتضمن "ص" أو "م" أو نطاقات أوقات محددة.
            // الطريقة الأكثر أماناً للتعامل كنص هي عرض كل شيء في مكان واحد، أو
            // استخدام تعبيرات عادية بسيطة للتحقق من وجود "ص" أو "م".
            if (slotString.includes('ص') || slotString.startsWith('9:') || slotString.startsWith('10:') || slotString.startsWith('11:') || slotString.startsWith('12:') && !slotString.includes('م')) { // مثال بسيط للتقسيم
                 morningSlotsGrid.appendChild(createTimeSlotButton(slotString, slotData && slotData.isBooked, slotData?.bookedBy?.name));
            } else {
                 eveningSlotsGrid.appendChild(createTimeSlotButton(slotString, slotData && slotData.isBooked, slotData?.bookedBy?.name));
            }
        });

        if (morningSlotsGrid.innerHTML === '' && eveningSlotsGrid.innerHTML === '') {
            morningSlotsGrid.innerHTML = '<p class="no-slots-message">لا توجد مواعيد متاحة في هذا اليوم.</p>';
        }
    }


    function toggleSlotSelection(slotString) {
        const isCurrentlySelected = selectedSlotsInModal.includes(slotString);
        if (isCurrentlySelected) {
            selectedSlotsInModal = selectedSlotsInModal.filter(s => s !== slotString);
        } else {
            selectedSlotsInModal.push(slotString);
        }
        console.log("Selected slots in modal:", selectedSlotsInModal);
    }


    function handleSaveTimeSlots(day) {
        M.toast({html: 'جاري حفظ المواعيد...', classes: 'blue lighten-1'});
        
        const modalInstance = M.Modal.getInstance(document.getElementById('timeSlotModal'));
        if (modalInstance) {
            modalInstance.close();
        }

        google.script.run
            .withSuccessHandler(function(response) {
                if (response.status === "success") {
                    M.toast({html: `تم تحديث مواعيد ${currentSelectedTeacherForUpdate} في يوم ${day} بنجاح.`, classes: 'green darken-1'});
                    loadTeacherDataFromServer('update'); // يجب إعادة تحميل البيانات بعد الحفظ لتنعكس التغييرات
                } else {
                    M.toast({html: `خطأ في حفظ المواعيد: ${response.message}`, classes: 'red darken-3'});
                }
            })
            .withFailureHandler(onFailure)
            .updateTeacherAvailableSchedules(currentSelectedTeacherForUpdate, day, selectedSlotsInModal);
    }


    // -----------------------------------------------------------
    // دوال إدارة بيانات المعلمين والمواعيد في الفورمز
    // -----------------------------------------------------------
    function initializeTeacherDataForForms(formType) {
        if (teachersNames.length > 0 || Object.keys(availableSchedules).length > 0) {
            console.log("Using pre-loaded initial data from general variables.");
            setupTeacherAndScheduleDropdowns(formType);
        } else {
            console.log("Pre-loaded initial data missing or empty. Falling back to server call.");
            loadTeacherDataFromServer('update'); // For update schedules page
        }
    }

    function loadTeacherDataFromServer(formType) {
        M.toast({html: 'جاري جلب بيانات المعلمين والمواعيد من السيرفر...', classes: 'blue lighten-1'});
        google.script.run
            .withSuccessHandler(function(jsonString) {
                const data = JSON.parse(jsonString);
                teachersNames = data.teacherNames;
                availableSchedules = data.availableSchedules;
                allSchedulesWithStatus = data.allSchedulesWithStatus;
                console.log("FALLBACK Teachers Data Received:", teachersNames);
                console.log("FALLBACK Available Schedules Received:", availableSchedules);
                setupTeacherAndScheduleDropdowns(formType);
            })
            .withFailureHandler(onFailure)
            .getTeacherAndAvailableSchedules(); 
    }

    function setupTeacherAndScheduleDropdowns(formType, studentData = null) {
        const subTypeSelectId = formType === 'add' ? 'new_subscription_type' : 'edit_subscription_type';
        const systemTypeSelectId = formType === 'add' ? 'new_system_type' : 'edit_system_type';
        let mainTeacherSelectId;
        if (formType === 'add') {
            mainTeacherSelectId = 'new_teacher_name';
        } else if (formType === 'edit') {
            mainTeacherSelectId = 'edit_teacher_name';
        } else if (formType === 'update') {
            mainTeacherSelectId = 'update_teacher_name';
        }
        
        if (document.getElementById(subTypeSelectId)) {
            M.FormSelect.init(document.getElementById(subTypeSelectId));
        }
        if (document.getElementById(systemTypeSelectId)) {
            M.FormSelect.init(document.getElementById(systemTypeSelectId));
        }

        const mainTeacherSelect = document.getElementById(mainTeacherSelectId);
        if (mainTeacherSelect) {
            mainTeacherSelect.innerHTML = `<option value="" disabled selected>اختر المعلم ${formType === 'update' ? 'لتحديث مواعيده' : 'الأساسي للطالب'}</option>`;
            teachersNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                mainTeacherSelect.appendChild(option);
            });
            M.FormSelect.init(mainTeacherSelect);
            if (formType === 'update') {
                displayTeacherSchedulesForUpdate();
            }
        }

        if (formType === 'edit' && studentData) {
            document.getElementById('edit_student_id').value = studentData.id;
            document.getElementById('edit_student_master_row').value = studentData.masterRow;
            document.getElementById('edit_student_subscription_date').value = studentData.subscriptionDate;
            document.getElementById('edit_student_name').value = studentData.name;
            document.getElementById('edit_student_age').value = studentData.age;
            document.getElementById('edit_student_number').value = studentData.number;

            document.getElementById(subTypeSelectId).value = studentData.subscriptionType;
            M.FormSelect.init(document.getElementById(subTypeSelectId));
            
            document.getElementById(systemTypeSelectId).value = studentData.system;
            M.FormSelect.init(document.getElementById(systemTypeSelectId));
            
            document.getElementById(mainTeacherSelectId).value = studentData.schedules && studentData.schedules.length > 0 ? studentData.schedules[0].teacherName : '';
            M.FormSelect.init(document.getElementById(mainTeacherSelectId));

            M.updateTextFields();
        }

        if (document.getElementById(systemTypeSelectId) && document.getElementById(systemTypeSelectId).value) {
            updateScheduleFields(formType, studentData ? studentData.schedules : []); 
        }
        M.updateTextFields();
    }

    function updateScheduleFields(formType, initialSchedules = []) {
        const systemTypeSelectId = formType === 'add' ? 'new_system_type' : 'edit_system_type';
        const scheduleContainerId = formType === 'add' ? 'addScheduleFieldsContainer' : 'editScheduleFieldsContainer';
        const teacherSelectIdPrefix = formType === 'add' ? 'schedule_teacher_' : 'edit_schedule_teacher_';
        const daySelectIdPrefix = formType === 'add' ? 'schedule_day_' : 'edit_schedule_day_';
        const timeSelectIdPrefix = formType === 'add' ? 'schedule_time_' : 'edit_schedule_time_';
        let mainTeacherSelectId;
        if (formType === 'add') {
            mainTeacherSelectId = 'new_teacher_name';
        } else if (formType === 'edit') {
            mainTeacherSelectId = 'edit_teacher_name';
        } else if (formType === 'update') {
            return; 
        }

        const systemTypeSelect = document.getElementById(systemTypeSelectId);
        const selectedSystem = systemTypeSelect.value;
        const scheduleContainer = document.getElementById(scheduleContainerId);
        scheduleContainer.innerHTML = '';

        let numberOfSchedules = getMonthlyMaxClassesForForm(selectedSystem);

        const mainTeacherName = document.getElementById(mainTeacherSelectId).value;
        if (!mainTeacherName && numberOfSchedules > 0) {
            M.toast({html: 'الرجاء اختيار المعلم الأساسي أولاً.', classes: 'red darken-3'});
            return;
        }

        for (let i = 0; i < numberOfSchedules; i++) {
            const scheduleGroup = document.createElement('div');
            scheduleGroup.className = 'schedule-input-group';
            const removeButtonHtml = formType === 'edit' && initialSchedules[i] ? 
                                     `<button class="btn red waves-effect waves-light remove-schedule-btn" type="button" onclick="removeScheduleField(${i})">
                                        <i class="material-icons right">close</i>حذف الميعاد
                                      </button>` : '';

            scheduleGroup.innerHTML = `
                <h6>الميعاد رقم ${i + 1}</h6>
                <div class="row">
                    <div class="input-field col s12 m6">
                        <select id="${teacherSelectIdPrefix}${i}" class="teacher-select" onchange="updateDayOptions(${i}, '${formType}')" required>
                            <option value="${mainTeacherName}" selected>${mainTeacherName}</option>
                        </select>
                        <label>المعلم</label>
                    </div>
                    <div class="input-field col s12 m6">
                        <select id="${daySelectIdPrefix}${i}" class="day-select" onchange="updateTimeOptions(${i}, '${formType}')" required>
                            <option value="" disabled selected>اختر اليوم</option>
                            </select>
                        <label>اليوم</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <select id="${timeSelectIdPrefix}${i}" class="time-select" required>
                            <option value="" disabled selected>اختر الميعاد</option>
                            </select>
                        <label>الميعاد</label>
                    </div>
                </div>
                ${removeButtonHtml}
            `;
            scheduleContainer.appendChild(scheduleGroup);
            
            M.FormSelect.init(scheduleGroup.querySelector(`#${teacherSelectIdPrefix}${i}`));
            M.FormSelect.init(scheduleGroup.querySelector(`#${daySelectIdPrefix}${i}`));
            M.FormSelect.init(scheduleGroup.querySelector(`#${timeSelectIdPrefix}${i}`));
            
            if (formType === 'edit' && initialSchedules[i]) {
                document.getElementById(`${teacherSelectIdPrefix}${i}`).value = initialSchedules[i].teacherName;
                M.FormSelect.init(document.getElementById(`${teacherSelectIdPrefix}${i}`));
                
                updateDayOptions(i, formType, initialSchedules[i].day);
            } else if (mainTeacherName) {
                updateDayOptions(i, formType);
            }
        }
        if (formType === 'edit' && initialSchedules.length > 0) {
            initialSchedules.forEach((schedule, idx) => {
                if (idx < numberOfSchedules) {
                    document.getElementById(`${timeSelectIdPrefix}${idx}`).value = schedule.time;
                    M.FormSelect.init(document.getElementById(`${timeSelectIdPrefix}${idx}`));
                }
            });
        }
        M.updateTextFields();
    }
    
    function removeScheduleField(index) {
        const scheduleContainerId = 'editScheduleFieldsContainer';
        const scheduleGroup = document.getElementById(scheduleContainerId).children[index];
        if (scheduleGroup) {
            scheduleGroup.remove();
            M.toast({html: 'تم حذف الميعاد من الواجهة. اضغط حفظ التعديلات لتأكيد التغيير.', classes: 'green darken-1'});
        }
    }


    // -----------------------------------------------------------
    // دوال تحميل البيانات للمعلمين والمواعيد
    // -----------------------------------------------------------
    function updateDayOptions(index, formType, initialDay = null) {
        const teacherSelectIdPrefix = formType === 'add' ? 'schedule_teacher_' : 'edit_schedule_teacher_';
        const daySelectIdPrefix = formType === 'add' ? 'schedule_day_' : 'edit_schedule_day_';
        const timeSelectIdPrefix = formType === 'add' ? 'schedule_time_' : 'edit_schedule_time_';

        const teacherName = document.getElementById(`${teacherSelectIdPrefix}${index}`).value;
        const daySelect = document.getElementById(`${daySelectIdPrefix}${index}`);
        daySelect.innerHTML = '<option value="" disabled selected>اختر اليوم</option>';

        if (teacherName && availableSchedules[teacherName]) {
            const days = Object.keys(availableSchedules[teacherName]);
            days.forEach(day => {
                const option = document.createElement('option');
                option.value = day;
                option.textContent = day;
                daySelect.appendChild(option);
            });
        }
        document.getElementById(`${daySelectIdPrefix}${index}`).value = initialDay;
        M.FormSelect.init(daySelect);
        if (initialDay) {
            updateTimeOptions(index, formType);
        }
    }

    function updateTimeOptions(index, formType) {
        const teacherSelectIdPrefix = formType === 'add' ? 'schedule_teacher_' : 'edit_schedule_teacher_';
        const daySelectIdPrefix = formType === 'add' ? 'schedule_day_' : 'edit_schedule_day_';
        const timeSelectIdPrefix = formType === 'add' ? 'schedule_time_' : 'edit_schedule_time_';

        const teacherName = document.getElementById(`${teacherSelectIdPrefix}${index}`).value;
        const dayName = document.getElementById(`${daySelectIdPrefix}${index}`).value;
        const timeSelect = document.getElementById(`${timeSelectIdPrefix}${index}`);
        timeSelect.innerHTML = '<option value="" disabled selected>اختر الميعاد</option>';

        if (teacherName && dayName && availableSchedules[teacherName] && availableSchedules[teacherName][dayName]) {
            const times = availableSchedules[teacherName][dayName];
            times.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                timeSelect.appendChild(option);
            });
        }
        M.FormSelect.init(timeSelect);
    }


    // -----------------------------------------------------------
    // دوال صفحة تعديل / حذف طالب
    // -----------------------------------------------------------

    let currentEditedStudent = null;

    function searchStudentAndDisplay() {
        const query = document.getElementById('edit_student_query').value.trim();
        if (!query) {
            M.toast({html: 'الرجاء إدخال معرف الطالب أو رقم الهاتف.', classes: 'red darken-3'});
            return;
        }

        M.toast({html: 'جاري البحث عن الطالب...', classes: 'blue lighten-1'});
        google.script.run
            .withSuccessHandler(function(jsonString) {
                if (jsonString) {
                    const studentData = JSON.parse(jsonString);
                    currentEditedStudent = studentData;
                    displayStudentForEdit(studentData);
                } else {
                    M.toast({html: 'لم يتم العثور على الطالب.', classes: 'red darken-3'});
                    document.getElementById('editStudentDetails').style.display = 'none';
                }
            })
            .withFailureHandler(onFailure)
            .searchStudent(query);
    }

    function displayStudentForEdit(studentData) {
        document.getElementById('edit_student_id').value = studentData.id;
        document.getElementById('edit_student_master_row').value = studentData.masterRow;
        document.getElementById('edit_student_subscription_date').value = studentData.subscriptionDate;
        document.getElementById('edit_student_name').value = studentData.name;
        document.getElementById('edit_student_age').value = studentData.age;
        document.getElementById('edit_student_number').value = studentData.number;

        setupTeacherAndScheduleDropdowns('edit', studentData);

        document.getElementById('editStudentDetails').style.display = 'block';
        M.updateTextFields();
    }

    // دالة التعديل من قائمة إدارة الطلاب (تمت الإضافة)
    function editStudentFromList(studentId) {
        // نضبط حقل البحث ونقوم بالبحث عن الطالب
        document.getElementById('edit_student_query').value = studentId;
        showEditDeleteStudentForm(); // عرض نموذج التعديل/الحذف
        searchStudentAndDisplay(); // البحث وعرض تفاصيل الطالب
    }

    function handleUpdateStudent(event) {
        event.preventDefault();

        if (!currentEditedStudent) {
            M.toast({html: 'لم يتم تحميل بيانات الطالب للتعديل.', classes: 'red darken-3'});
            return;
        }

        const updatedStudentData = {
            id: document.getElementById('edit_student_id').value,
            masterRow: parseInt(document.getElementById('edit_student_master_row').value),
            subscriptionDate: document.getElementById('edit_student_subscription_date').value,
            name: document.getElementById('edit_student_name').value,
            age: document.getElementById('edit_student_age').value,
            number: document.getElementById('edit_student_number').value,
            subscriptionType: document.getElementById('edit_subscription_type').value,
            systemType: document.getElementById('edit_system_type').value,
            schedules: []
        };

        const scheduleContainer = document.getElementById('editScheduleFieldsContainer');
        const scheduleGroups = scheduleContainer.querySelectorAll('.schedule-input-group');

        for (let i = 0; i < scheduleGroups.length; i++) {
            const teacherSelect = scheduleGroups[i].querySelector(`[id^='edit_schedule_teacher_']`);
            const daySelect = scheduleGroups[i].querySelector(`[id^='edit_schedule_day_']`);
            const timeSelect = scheduleGroups[i].querySelector(`[id^='edit_schedule_time_']`);

            if (!teacherSelect || !daySelect || !timeSelect) {
                 continue;
            }

            const teacherName = teacherSelect.value;
            const day = daySelect.value;
            const time = timeSelect.value;

            if (!teacherName || !day || !time) {
                M.toast({html: `الرجاء اختيار المعلم واليوم والميعاد لجميع الحصص المطلوبة (ميعاد رقم ${i + 1}).`, classes: 'red darken-3'});
                return;
            }
            updatedStudentData.schedules.push({ teacherName, day, time });
        }
        
        M.toast({html: 'جاري حفظ التعديلات...', classes: 'blue lighten-1'});
        google.script.run
            .withSuccessHandler(function(response) {
                if (response.status === "success") {
                    M.toast({html: `تم حفظ تعديلات الطالب ${updatedStudentData.id} بنجاح.`, classes: 'green darken-1'});
                    goHome();
                } else {
                    M.toast({html: `خطأ في حفظ التعديلات: ${response.message}`, classes: 'red darken-3'});
                }
            })
            .withFailureHandler(onFailure)
            .updateStudent(updatedStudentData);
    }

    function promptDeleteStudent() {
        const studentId = document.getElementById('edit_student_id').value;
        const studentName = document.getElementById('edit_student_name').value;
        const reason = prompt(`هل أنت متأكد من حذف الطالب ${studentName} (${studentId})؟\n\nالرجاء إدخال سبب الحذف (اختياري):`);

        if (reason !== null) {
            executeDeleteStudent(studentId, reason);
        }
    }

    // دالة الحذف من قائمة إدارة الطلاب (تمت الإضافة)
    function promptDeleteStudentFromList(studentId, studentName) {
        const reason = prompt(`هل أنت متأكد من حذف الطالب ${studentName} (${studentId})؟\n\nالرجاء إدخال سبب الحذف (اختياري):`);

        if (reason !== null) {
            executeDeleteStudent(studentId, reason);
        }
    }

    // دالة تنفيذ الحذف المشتركة (تمت الإضافة)
    function executeDeleteStudent(studentId, reason) {
        M.toast({html: `جاري حذف الطالب ${studentId}...`, classes: 'orange darken-2'});
        google.script.run
            .withSuccessHandler(function(response) {
                if (response.status === "success") {
                    M.toast({html: `تم حذف الطالب ${studentId} بنجاح.`, classes: 'green darken-1'});
                    goHome();
                } else {
                    M.toast({html: `خطأ في حذف الطالب: ${response.message}`, classes: 'red darken-3'});
                }
            })
            .withFailureHandler(onFailure)
            .deleteStudent(studentId, reason);
    }


    // -----------------------------------------------------------
    // دوال لإضافة طالب جديد
    // -----------------------------------------------------------

    function handleNewStudentSubmit(event) {
        event.preventDefault();

        const studentData = {
            name: document.getElementById('new_student_name').value,
            age: document.getElementById('new_student_age').value,
            number: document.getElementById('new_student_number').value,
            subscriptionType: document.getElementById('new_subscription_type').value,
            systemType: document.getElementById('new_system_type').value,
            schedules: []
        };

        const numberOfSchedules = getMonthlyMaxClassesForForm(studentData.systemType);
        const scheduleContainer = document.getElementById('addScheduleFieldsContainer');
        
        const scheduleGroups = scheduleContainer.querySelectorAll('.schedule-input-group');

        for (let i = 0; i < numberOfSchedules; i++) {
            const teacherSelect = scheduleGroups[i].querySelector(`#schedule_teacher_${i}`);
            const daySelect = scheduleGroups[i].querySelector(`#schedule_day_${i}`);
            const timeSelect = scheduleGroups[i].querySelector(`#schedule_time_${i}`);

            if (!teacherSelect || !daySelect || !timeSelect) {
                 M.toast({html: `الرجاء اختيار المعلم واليوم والميعاد لجميع الحصص المطلوبة (ميعاد رقم ${i + 1}).`, classes: 'red darken-3'});
                 return;
            }

            const teacherName = teacherSelect.value;
            const day = daySelect.value;
            const time = timeSelect.value;

            if (!teacherName || !day || !time) {
                M.toast({html: `الرجاء اختيار المعلم واليوم والميعاد لجميع الحصص المطلوبة (ميعاد رقم ${i + 1}).`, classes: 'red darken-3'});
                return;
            }
            studentData.schedules.push({ teacherName, day, time });
        }

        M.toast({html: 'جاري إضافة الطالب الجديد...', classes: 'blue lighten-1'});
        google.script.run
            .withSuccessHandler(function(response) {
                if (response.status === "success") {
                    M.toast({html: `تم إضافة الطالب بنجاح! المعرف: ${response.studentId}`, classes: 'green darken-1'});
                    goHome();
                } else {
                    M.toast({html: `خطأ في إضافة الطالب: ${response.message}`, classes: 'red darken-3'});
                }
            })
            .withFailureHandler(onFailure)
            .addNewStudent(studentData);
    }

    // تحميل الطلاب عند فتح الواجهة
    document.addEventListener('DOMContentLoaded', function() {
        goHome();
    });
  </script>
</body>
</html>
