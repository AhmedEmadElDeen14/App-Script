<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام إدارة أكاديمية غيث</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    /* ************************************ */
    /* أنماط عامة للصفحة بالكامل */
    /* ************************************ */
    body {
      font-family: 'Cairo', Arial, sans-serif;
      background-color: #e0e7ee;
      margin: 0;
      padding: 0;
      direction: rtl;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #333;
      overflow-y: auto; /* السماح بالتمرير إذا كان المحتوى أطول من الشاشة */
    }

    /* كلاس لإخفاء الصفحات */
    .page-section {
      display: none;
      width: 100%; /* تأكد أن القسم يأخذ العرض الكامل */
      max-width: 1000px; /* أقصى عرض للكونتينرات الكبيرة */
      background: #ffffff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      margin: 20px auto; /* هامش علوي وسفلي لتوسيط الكونتينر داخل الـ body */
      box-sizing: border-box; /* لضمان أن الـ padding لا يزيد العرض */
    }
    .page-section.active {
      display: block; /* إظهار الصفحة النشطة */
    }

    /* أنماط العناوين العامة */
    h1, h2, h3 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
      position: relative;
      padding-bottom: 10px;
      font-weight: 700;
    }
    h1::after, h2::after {
      content: '';
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background-color: #3498db;
      border-radius: 2px;
    }
    h1 { font-size: 2.5em; }
    h2 { font-size: 2.0em; width: fit-content; margin: 30px auto; } /* توسيط H2s */
    h2::after { width: 60px; height: 3px; }


    /* ************************************ */
    /* ستايل عام للأزرار والمدخلات والقوائم */
    /* ************************************ */
    .button { /* كلاس Milligram للأزرار */
      font-family: 'Cairo', Arial, sans-serif;
      padding: 10px 20px;
      border-radius: 8px; 
      font-size: 1em;
      transition: background-color 0.3s ease;
      cursor: pointer;
    }
    .button-primary { 
        background-color: #007BFF;
        color: white;
    }
    .button-primary:hover {
        background-color: #0056b3;
    }
    .button.back-button { 
        background-color: #6c757d;
        color: white;
    }
    .button.back-button:hover {
        background-color: #5a6268;
    }
    .button.delete {
        background-color: #e74c3c;
        color: white;
    }
    .button.delete:hover {
        background-color: #c0392b;
    }

    input[type="text"],
    input[type="number"],
    input[type="tel"],
    select {
      height: 40px;
      border-radius: 5px;
      border: 1px solid #ddd;
      padding: 0 10px;
      width: 100%;
      box-sizing: border-box; /* للتأكد أن الـ padding لا يزيد العرض الكلي */
      font-family: 'Cairo', Arial, sans-serif; /* لضمان الخط العربي */
    }

    /* ستايل عام للأيقونات داخل الأزرار */
    .button i {
      margin-right: 8px; /* مسافة بين الأيقونة والنص في الأزرار اللي اتجاهها من اليمين لليسار */
      vertical-align: middle; /* لمحاذاة الأيقونة رأسياً مع النص */
    }
    /* لو الأيقونة بعد النص في اللغة العربية */
    .button i:last-child {
      margin-right: 0;
      margin-left: 8px; /* مسافة بعد النص */
    }

    /* ستايل لأيقونات التحميل (spinners) */
    .fa-spinner {
      animation: fa-spin 1s infinite linear; /* أنيميشن دوران */
    }
    /* عند تعطيل زر أثناء التحميل */
    .button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }


    /* ************************************ */
    /* أنماط الصفحة الرئيسية (main-page) */
    /* ************************************ */
    #main-page.page-section {
        max-width: 500px; 
        text-align: center;
    }
    #main-page h1 { font-size: 2.2em; }
    #main-page h1::after { width: 60px; height: 3px; }
    .button-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-top: 20px;
    }
    .main-button { /* Overrides for main buttons */
      padding: 15px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1.2em;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      text-decoration: none;
      display: block;
      font-family: 'Cairo', Arial, sans-serif;
      font-weight: 600;
      color: white; 
    }
    .main-button.dashboard { background-color: #27ae60; }
    .main-button.dashboard:hover { background-color: #229a53; }
    .main-button.register { background-color: #e67e22; }
    .main-button.register:hover { background-color: #d35400; }
    .main-button.edit { background-color: #9b59b6; }
    .main-button.edit:hover { background-color: #8e44ad; }
    .main-button.teacher { background-color: #1abc9c; }
    .main-button.teacher:hover { background-color: #16a085; }
    .main-button.all-students { background-color: #34495e; } 
    .main-button.all-students:hover { background-color: #2c3e50; }
    .main-button.archive { background-color: #5d6d7e; } 
    .main-button.archive:hover { background-color: #495a69; }
    .main-button.manage-slots { background-color: #2980b9; } 
    .main-button.manage-slots:hover { background-color: #23699b; }


    /* ************************************ */
    /* Toast Notifications */
    /* ************************************ */
    #toast-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        display: flex;
        flex-direction: column-reverse; /* لعرض الجديد في الأعلى */
        gap: 10px;
        align-items: center; /* لتوسيط التوست إذا كان هناك أكثر من واحد */
    }
    .toast {
        background-color: #333;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-out;
        transform: translateY(20px);
        min-width: 250px;
        max-width: 400px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-family: 'Cairo', Arial, sans-serif;
        font-size: 1.1em;
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    .toast.success { background-color: #27ae60; }
    .toast.error { background-color: #e74c3c; }
    .toast.info { background-color: #3498db; }
    .toast i { margin-right: 0; margin-left: 10px; } /* عكس المارجن للأيقونة في التوست */
    .hidden {
      display: none !important;
    }

  </style>
</head>
<body>
  <div id="main-page" class="page-section active">
    <h1>أكاديمية غيث</h1>
    <div class="button-grid">
      <button class="main-button dashboard" onclick="showPage('dashboard-page', loadDashboardStats)"><i class="fas fa-chart-line"></i> لوحة التحكم</button>
      <button class="main-button register" onclick="showPage('form-page', loadFormDependencies)"><i class="fas fa-user-plus"></i> تسجيل طالب جديد</button>
      <button class="main-button edit" onclick="showPage('edit-student-page', loadEditStudentDependencies)"><i class="fas fa-user-edit"></i> تعديل بيانات طالب</button>
      <button class="main-button teacher" onclick="showPage('teacher-schedule-page', loadTeacherScheduleDependencies)"><i class="fas fa-chalkboard-teacher"></i> تسجيل حضور المعلمين</button>
      <button class="main-button all-students" onclick="showPage('all-students-page', loadAllStudentsDependencies)"><i class="fas fa-users"></i> كل الطلاب</button>
      <button class="main-button archive" onclick="showPage('archive-page', loadArchivedStudentsDependencies)"><i class="fas fa-archive"></i> أرشيف الطلاب</button>
      <button class="main-button manage-slots" onclick="showPage('manage-slots-page', loadManageSlotsDependencies)"><i class="fas fa-clock"></i> إدارة مواعيد المعلمين</button>
    </div>
  </div>

  <div id="dashboard-page" class="page-section">
    <h1><i class="fas fa-chart-line"></i> لوحة التحكم: ملخص الأكاديمية</h1>
    
    <div id="dashboard-content">
      <div class="stats-section">
        <h2>ملخص الطلاب</h2>
        <div class="dashboard-stats-grid">
          <div class="stat-card summary">
            <h3>إجمالي الطلاب</h3>
            <p id="totalStudentsCount">0</p>
          </div>
          <div class="stat-card summary">
            <h3>طلاب مشتركين</h3>
            <p id="registeredStudentsCount">0</p>
          </div>
          <div class="stat-card summary">
            <h3>حلقات تجريبية</h3>
            <p id="trialStudentsCount">0</p>
          </div>
          <div class="stat-card summary">
            <h3>طلاب قيد المراجعة</h3>
            <p id="pendingStudentsCount">0</p>
          </div>
          <div class="stat-card">
            <h3>يحتاجون للتجديد الأسبوع القادم</h3>
            <p id="renewalNextWeekCount" class="danger">0</p>
          </div>
        </div>
      </div>

      <div class="stats-section">
        <h2>حالة التجديد</h2>
        <div class="dashboard-stats-grid">
          <div class="stat-card">
            <h3>يحتاج للتجديد</h3>
            <p id="needsRenewalCount" class="warn">0</p>
          </div>
          <div class="stat-card">
            <h3>انتهت مدة الاشتراك</h3>
            <p id="expiredCount" class="danger">0</p>
          </div>
          <div class="stat-card">
            <h3>تجاوز الحد</h3>
            <p id="overLimitCount" class="danger">0</p>
          </div>
          <div class="stat-card">
            <h3>تم التجديد (نشط)</h3>
            <p id="renewedCount">0</p>
          </div>
          <div class="stat-card">
            <h3>حلقات تجريبية نشطة</h3>
            <p id="activeTrialCount">0</p>
          </div>
          <div class="stat-card">
            <h3>لم يشتركوا</h3>
            <p id="notSubscribedCount">0</p>
          </div>
        </div>
      </div>

      <div class="stats-section">
        <h2>توزيع الطلاب حسب الباقة</h2>
        <div class="chart-container">
          <div id="packagePieChart"></div>
        </div>
      </div>

      <div class="stats-section">
        <h2>الطلاب حسب الباقة</h2>
        <ul id="studentsByPackageList" class="stats-list">
          </ul>
      </div>

      <div class="stats-section">
        <h2>الطلاب لكل معلم</h2>
        <div class="chart-container">
          <div id="teachersBarChart"></div> </div>
        <ul id="studentsByTeacherList" class="stats-list">
          </ul>
      </div>

      <div class="stats-section">
        <h2>حالة التجديد التفصيلية</h2>
        <div class="chart-container">
          <div id="renewalStatusPieChart"></div> </div>
      </div>

      <div class="stats-section">
        <h2>الطلاب المسجلين حديثاً</h2>
        <ul class="stats-list">
          <li>آخر 7 أيام: <span id="last7DaysCount">0</span></li>
          <li>آخر 30 يومًا: <span id="last30DaysCount">0</span></li>
        </ul>
      </div>

      <div class="stats-section">
        <h2>الطلاب الذين يحتاجون للتجديد قريباً</h2>
        <div class="renewal-students-details">
          <h3 id="renewalDetailsTitle"></h3>
          <ul id="renewalNextWeekList" class="stats-list">
            <li>جارٍ تحميل البيانات...</li>
          </ul>
        </div>
      </div>
      
      <div class="button-container">
          <button class="button refresh-button" onclick="loadDashboardStats()"><i class="fas fa-sync-alt"></i> تحديث البيانات</button>
          <button class="button back-button" onclick="showPage('main-page')"><i class="fas fa-arrow-right"></i> العودة للصفحة الرئيسية</button>
      </div>
    </div>
  </div>

  <div id="form-page" class="page-section">
    <h2><i class="fas fa-user-plus"></i> نموذج تسجيل البيانات</h2>
    <form id="dataForm">
      <div class="row">
        <div class="column">
          <label for="regName">اسم الطالب:</label>
          <input type="text" id="regName" placeholder="أدخل اسم الطالب" required>
        </div>
      </div>
      <div class="row">
        <div class="column">
          <label for="regAge">السن:</label>
          <input type="number" id="regAge" placeholder="أدخل السن" required>
        </div>
      </div>
      <div class="row">
        <div class="column">
          <label for="regPhone">رقم الهاتف:</label>
          <input type="tel" id="regPhone" placeholder="أدخل رقم الهاتف" required>
        </div>
      </div>
      <div class="row">
        <div class="column">
          <label for="regTeacher">المعلم:</label>
          <select id="regTeacher" onchange="updateRegDays()" required>
            <option value="" disabled selected>اختر معلمًا</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="column column-50">
          <label for="regDay1">اليوم الأول:</label>
          <select id="regDay1" onchange="updateRegTimes('regDay1', 'regTime1')" required>
            <option value="" disabled selected>اختر يومًا</option>
          </select>
        </div>
        <div class="column column-50">
          <label for="regTime1">الميعاد الأول:</label>
          <select id="regTime1" required>
            <option value="" disabled selected>اختر ميعادًا</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="column column-50">
          <label for="regDay2">اليوم الثاني:</label>
          <select id="regDay2" onchange="updateRegTimes('regDay2', 'regTime2')">
            <option value="" disabled selected>اختر يومًا (اختياري)</option>
          </select>
        </div>
        <div class="column column-50">
          <label for="regTime2">الميعاد الثاني:</label>
          <select id="regTime2">
            <option value="" disabled selected>اختر ميعادًا (اختياري)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="column column-50">
          <label for="regPaymentStatus">حالة الدفع:</label>
          <select id="regPaymentStatus" required>
            <option value="" disabled selected>اختر حالة الدفع</option>
          </select>
        </div>
        <div class="column column-50">
          <label for="regSubscriptionPackage">باقة الاشتراك:</label>
          <select id="regSubscriptionPackage" required>
            <option value="" disabled selected>اختر باقة</option>
          </select>
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="button button-primary" onclick="submitData()"><i class="fas fa-save"></i> تسجيل البيانات</button>
        <button type="button" class="button back-button" onclick="showPage('main-page')"><i class="fas fa-arrow-right"></i> العودة للصفحة الرئيسية</button>
      </div>
    </form>
  </div>

  <div id="edit-student-page" class="page-section">
    <h2><i class="fas fa-user-edit"></i> تعديل بيانات الطالب</h2>
    <div class="row">
      <div class="column column-75">
        <label for="searchStudentId">ابحث بـ Student ID:</label>
        <input type="text" id="searchStudentId" placeholder="أدخل Student ID أو رقم الهاتف"> </div>
      <div class="column column-25">
        <button class="button button-primary" onclick="fetchStudentData()" id="searchButton"><i class="fas fa-search"></i> بحث</button>
      </div>
    </div>

    <div id="studentForm" class="hidden">
      <div class="row">
        <div class="column">
          <label for="editStudentId">Student ID:</label>
          <input type="text" id="editStudentId" disabled> </div>
      </div>
      <div class="row">
        <div class="column">
          <label for="editName">اسم الطالب:</label>
          <input type="text" id="editName">
        </div>
      </div>

      <div class="row">
        <div class="column">
          <label for="editAge">السن:</label>
          <input type="number" id="editAge">
        </div>
      </div>
      
      <div class="row">
        <div class="column">
          <label for="editPhone">رقم الهاتف (ولي الأمر):</label>
          <input type="tel" id="editPhone">
        </div>
      </div>

      <div class="row">
        <div class="column">
          <label for="editTeacher">المعلم:</label>
          <select id="editTeacher" onchange="updateEditDays()"></select>
        </div>
      </div>

      <div class="row">
        <div class="column column-50">
          <label>اليوم الأول (الحالي):</label>
          <span id="currentDay1">-</span>
        </div>
        <div class="column column-50">
          <label for="editDay1">اليوم الأول (الجديد):</label>
          <select id="editDay1" onchange="updateEditTimes('editDay1', 'editTime1')"></select>
        </div>
      </div>

      <div class="row">
        <div class="column column-50">
          <label>الميعاد الأول (الحالي):</label>
          <span id="currentTime1">-</span>
        </div>
        <div class="column column-50">
          <label for="editTime1">الميعاد الأول (الجديد):</label>
          <select id="editTime1"></select>
        </div>
      </div>

      <div class="row">
        <div class="column column-50">
          <label>اليوم الثاني (الحالي):</label>
          <span id="currentDay2">-</span>
        </div>
        <div class="column column-50">
          <label for="editDay2">اليوم الثاني (الجديد):</label>
          <select id="editDay2" onchange="updateEditTimes('editDay2', 'editTime2')"></select>
        </div>
      </div>

      <div class="row">
        <div class="column column-50">
          <label>الميعاد الثاني (الحالي):</label>
          <span id="currentTime2">-</span>
        </div>
        <div class="column column-50">
          <label for="editTime2">الميعاد الثاني (الجديد):</label>
          <select id="editTime2"></select>
        </div>
      </div>

      <div class="row">
        <div class="column">
          <label for="editPaymentStatus">حالة الدفع (حالة التجديد):</label>
          <select id="editPaymentStatus"></select>
        </div>
      </div>

      <div class="row">
        <div class="column">
          <label for="editSubscriptionPackage">نوع الباقة:</label>
          <select id="editSubscriptionPackage"></select>
        </div>
      </div>

      <div class="action-buttons-container">
        <button class="button button-primary" onclick="updateStudentData()"><i class="fas fa-save"></i> حفظ التعديلات</button>
        <button class="button delete" onclick="deleteStudent()"><i class="fas fa-trash-alt"></i> حذف الطالب</button>
        <button class="button back-button" onclick="showPage('main-page')"><i class="fas fa-arrow-right"></i> العودة للصفحة الرئيسية</button>
      </div>
    </div>
  </div>

  <div id="all-students-page" class="page-section">
    <h2><i class="fas fa-users"></i> كل الطلاب</h2>
    <div class="filters-and-search">
      <div class="column">
        <label for="allStudentsSearch">بحث (الاسم، الهاتف، ID):</label>
        <input type="text" id="allStudentsSearch" placeholder="ابحث هنا..." onkeyup="filterAndSortStudents()">
      </div>
      <div class="column">
        <label for="filterTeacher">المعلم:</label>
        <select id="filterTeacher" onchange="filterAndSortStudents()">
          <option value="">كل المعلمين</option>
        </select>
      </div>
      <div class="column">
        <label for="filterPackage">الباقة:</label>
        <select id="filterPackage" onchange="filterAndSortStudents()">
          <option value="">كل الباقات</option>
        </select>
      </div>
      <div class="column">
        <label for="filterPaymentStatus">حالة الدفع:</label>
        <select id="filterPaymentStatus" onchange="filterAndSortStudents()">
          <option value="">كل الحالات</option>
        </select>
      </div>
      <div class="column">
        <label for="filterRenewalStatus">حالة التجديد:</label>
        <select id="filterRenewalStatus" onchange="filterAndSortStudents()">
          <option value="">كل الحالات</option>
        </select>
      </div>
    </div>
    
    <div class="button-container" style="justify-content: flex-start; margin-bottom: 20px;">
        <button class="button refresh-button" onclick="loadAllStudentsData()"><i class="fas fa-sync-alt"></i> تحديث البيانات</button>
    </div>

    <table id="allStudentsTable">
      <thead>
        <tr>
          <th onclick="filterAndSortStudents('name')">الاسم <i class="fas fa-sort"></i></th>
          <th onclick="filterAndSortStudents('studentID')">Student ID <i class="fas fa-sort"></i></th>
          <th onclick="filterAndSortStudents('phone')">رقم الهاتف <i class="fas fa-sort"></i></th>
          <th onclick="filterAndSortStudents('teacherName')">المعلم <i class="fas fa-sort"></i></th> <th onclick="filterAndSortStudents('packageName')">الباقة <i class="fas fa-sort"></i></th> <th onclick="filterAndSortStudents('attendedSessions')">الحصص الحاضرة <i class="fas fa-sort"></i></th>
          <th onclick="filterAndSortStudents('remainingSessions')">الحصص المتبقية <i class="fas fa-sort"></i></th>
          <th onclick="filterAndSortStudents('renewalStatus')">حالة التجديد <i class="fas fa-sort"></i></th>
          <th onclick="filterAndSortStudents('registrationDate')">تاريخ التسجيل <i class="fas fa-sort"></i></th>
          <th onclick="filterAndSortStudents('day1')">الميعاد الأول <i class="fas fa-sort"></i></th> <th onclick="filterAndSortStudents('day2')">الميعاد الثاني <i class="fas fa-sort"></i></th> <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="12" class="no-data-message">جارٍ تحميل بيانات الطلاب...</td></tr> </tbody>
    </table>
    <div class="button-container">
        <button class="button back-button" onclick="showPage('main-page')"><i class="fas fa-arrow-right"></i> العودة للصفحة الرئيسية</button>
    </div>
  </div>

  <div id="archive-page" class="page-section">
      <h2><i class="fas fa-archive"></i> أرشيف الطلاب</h2>
      <div class="filters-and-search">
        <div class="column">
          <label for="archiveSearch">بحث (الاسم، الهاتف، ID):</label>
          <input type="text" id="archiveSearch" placeholder="ابحث هنا..." onkeyup="filterAndSortArchivedStudents()">
        </div>
        <div class="column">
          <label for="filterArchiveTeacher">المعلم:</label>
          <select id="filterArchiveTeacher" onchange="filterAndSortArchivedStudents()">
            <option value="">كل المعلمين</option>
          </select>
        </div>
        <div class="column">
          <label for="filterArchivePackage">الباقة:</label>
          <select id="filterArchivePackage" onchange="filterAndSortArchivedStudents()">
            <option value="">كل الباقات</option>
          </select>
        </div>
        <div class="column">
          <label for="filterArchiveStatus">حالة الطالب:</label>
          <select id="filterArchiveStatus" onchange="filterAndSortArchivedStudents()">
            <option value="">كل الحالات</option>
          </select>
        </div>
        </div>
      
      <div class="button-container" style="justify-content: flex-start; margin-bottom: 20px;">
          <button class="button refresh-button" onclick="loadArchivedStudentsData()"><i class="fas fa-sync-alt"></i> تحديث البيانات</button>
      </div>

      <table id="archivedStudentsTable">
        <thead>
          <tr>
            <th onclick="filterAndSortArchivedStudents('name')">الاسم <i class="fas fa-sort"></i></th>
            <th onclick="filterAndSortArchivedStudents('studentID')">Student ID <i class="fas fa-sort"></i></th>
            <th onclick="filterAndSortArchivedStudents('phone')">رقم الهاتف <i class="fas fa-sort"></i></th>
            <th onclick="filterAndSortArchivedStudents('teacherName')">المعلم <i class="fas fa-sort"></i></th> <th onclick="filterAndSortArchivedStudents('packageName')">الباقة <i class="fas fa-sort"></i></th> <th onclick="filterAndSortArchivedStudents('archivedDate')">تاريخ الأرشفة <i class="fas fa-sort"></i></th>
            <th onclick="filterAndSortArchivedStudents('archiveReason')">سبب الأرشفة <i class="fas fa-sort"></i></th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="8" class="no-data-message">جارٍ تحميل بيانات الطلاب المؤرشفين...</td></tr> </tbody>
      </table>
      <div class="button-container">
          <button class="button back-button" onclick="showPage('main-page')"><i class="fas fa-arrow-right"></i> العودة للصفحة الرئيسية</button>
      </div>
  </div>

  <div id="teacher-schedule-page" class="page-section">
    <h2><i class="fas fa-chalkboard-teacher"></i> تسجيل حضور المعلمين</h2>

    <div class="form-group">
      <input type="tel" id="teacherPhone" placeholder="أدخل رقم هاتف المعلم">
      <button onclick="loadTeacherSchedule()"><i class="fas fa-search"></i> بحث</button>
    </div>

    <div id="teacherInfo" class="hidden">
      <h2 id="currentTeacherNameDisplay"></h2>
      <p>جدول الطلاب لهذا اليوم: <span id="currentDayNameDisplay"></span></p>
    </div>

    <div id="attendanceSection" class="hidden">
      <h3>الطلاب المسجلون لهذا اليوم:</h3>
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>اسم الطالب</th>
            <th>معرف الطالب (ID)</th>
            <th>الميعاد</th>
            <th>الإجراء</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
    </div>
    <p id="teacherStatusMessage" class="status-message hidden"></p>

    <div class="back-button-container">
      <button class="button back-button" onclick="showPage('main-page')"><i class="fas fa-arrow-right"></i> العودة للصفحة الرئيسية</button>
    </div>
  </div>

  <div id="manage-slots-page" class="page-section">
      <h2><i class="fas fa-clock"></i> إدارة مواعيد المعلمين</h2>
      <div class="form-group">
        <label for="selectManageTeacher">اختر المعلم:</label>
        <select id="selectManageTeacher" style="flex-grow: 1; max-width: 300px;" onchange="loadTeacherSlotsForManagement()"></select>
      </div>

      <div id="manageSlotsTeacherInfo" class="hidden">
          <div class="teacher-name-display" id="manageSlotsTeacherName"></div>
          <p class="no-slots-message hidden" id="noManageSlotsMessage">لا توجد مواعيد مضافة لهذا المعلم حالياً.</p>
          <table class="teacher-slots-table">
              <thead>
                  <tr>
                      <th>اليوم</th>
                      <th>المواعيد المتاحة/المحجوزة</th>
                      <th>الإجراء</th>
                  </tr>
              </thead>
              <tbody id="teacherSlotsTableBody">
                  </tbody>
          </table>
      </div>
      <p id="manageSlotsStatusMessage" class="status-message hidden"></p>

      <div class="button-container">
          <button class="button back-button" onclick="showPage('main-page')"><i class="fas fa-arrow-right"></i> العودة للصفحة الرئيسية</button>
      </div>
  </div>

    <div id="timeSlotSelectionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeTimeSlotModal()"><i class="fas fa-times"></i></button>
            <h3 id="modalDayTitle">تحديد مواعيد يوم </h3>

            <div class="time-slots-modal-sections">
                <div class="slots-section">
                    <h4>مواعيد صباحية (09:00 ص - 03:00 م)</h4>
                    <div class="time-slots-grid" id="morningSlotsGrid">
                        </div>
                </div>

                <div class="slots-section">
                    <h4>مواعيد مسائية (03:00 م - 11:30 م)</h4> <div class="time-slots-grid" id="eveningSlotsGrid">
                        </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="button save-button" onclick="saveSelectedSlots()"><i class="fas fa-check-circle"></i> تأكيد المواعيد</button>
                <button class="button cancel-button" onclick="closeTimeSlotModal()"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

  <script>
    // ************************************ //
    //          متغيرات عالمية مشتركة (تعرف مرة واحدة فقط) //
    // ************************************ //
    let teacherData = {}; // بيانات المعلمين المشتركة (مواعيدهم المتاحة، تجلبها دالة getTeacherData)
    let studentData = {}; // بيانات الطالب المحملة في صفحة التعديل (edit-student-page)
    let allStudentsRawData = []; // تخزين جميع بيانات الطلاب لفلترتها وفرزها (all-students-page)
    let archivedStudentsRawData = []; // تخزين جميع بيانات الطلاب المؤرشفين (archive-page)

    let currentTeacherName = ''; // لصفحة حضور المعلمين
    let currentDay = ''; // لصفحة حضور المعلمين (يتم حسابه عند تحميل الصفحة)

    let currentManageSlotsTeacherName = ''; // لإدارة مواعيد المعلمين
    let currentManageSlotsTeacherId = ''; 
    let currentTeacherAllAvailableSlots = []; // جميع المواعيد المتاحة/المحجوزة للمعلم من شيت المعلمين
    let modalSelectedDay = ''; // اليوم الذي يتم تعديل مواعيده في المودال (لإدارة المواعيد)
    let modalSelectedSlots = []; // المواعيد المختارة داخل المودال (لإدارة المواعيد)

    // دوال الفرز (مشتركة لـ all-students-page و archive-page)
    let sortColumn = null; 
    let sortDirection = 'asc'; 
    let archiveSortColumn = null;
    let archiveSortDirection = 'asc';

    // قائمة المواعيد المحتملة (تستخدم في المودال لإدارة المواعيد)
    const possibleTimeSlots24Hour = [
        "09:00 - 09:30", "09:30 - 10:00", "10:00 - 10:30", "10:30 - 11:00",
        "11:00 - 11:30", "11:30 - 12:00", "12:00 - 12:30", "12:30 - 13:00",
        "13:00 - 13:30", "13:30 - 14:00", "14:00 - 14:30", "14:30 - 15:00",
        "15:00 - 15:30", "15:30 - 16:00", "16:00 - 16:30", "16:30 - 17:00",
        "17:00 - 17:30", "17:30 - 18:00", "18:00 - 18:30", "18:30 - 19:00",
        "19:00 - 19:30", "19:30 - 20:00", "20:00 - 20:30", "20:30 - 21:00",
        "21:00 - 21:30", "21:30 - 22:00", "22:00 - 22:30", "22:30 - 23:00",
        "23:00 - 23:30", "23:30 - 00:00" // تم إضافة الساعتين الجديدتين
    ];


    // ************************************ //
    //          دوال التنقل بين الصفحات والأساسيات العامة        //
    // ************************************ //

    /**
     * دالة لإظهار صفحة معينة وإخفاء البقية.
     * @param {string} pageId - ID الخاص بـ div الصفحة المراد إظهارها.
     * @param {function} [callback] - دالة يتم تنفيذها بعد إظهار الصفحة (لتحميل البيانات مثلاً).
     */
    function showPage(pageId, callback) {
      const pages = document.querySelectorAll('.page-section');
      pages.forEach(page => page.classList.remove('active')); // إخفاء كل الصفحات

      const activePage = document.getElementById(pageId);
      if (activePage) {
        activePage.classList.add('active'); // إظهار الصفحة المطلوبة
        window.scrollTo(0, 0); // الانتقال لأعلى الصفحة

        if (typeof callback === 'function') {
          callback(); // تنفيذ دالة الـ callback (مثل تحميل البيانات) بعد إظهار الصفحة
        }
      } else {
        console.error(`Page with ID '${pageId}' not found.`);
        showToast(`خطأ: لم يتم العثور على الصفحة '${pageId}'.`, 'error');
      }
    }

    /**
     * دالة لعرض رسائل تنبيه مؤقتة (Toasts).
     * @param {string} message - نص الرسالة.
     * @param {string} type - نوع الرسالة ('success', 'error', 'info').
     * @param {number} duration - مدة عرض الرسالة بالمللي ثانية.
     */
    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            console.error('Toast container not found!');
            alert(message); // Fallback to alert
            return;
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let iconHtml = '';
        if (type === 'success') {
            iconHtml = '<i class="fas fa-check-circle"></i>';
        } else if (type === 'error') {
            iconHtml = '<i class="fas fa-exclamation-circle"></i>';
        } else { // info
            iconHtml = '<i class="fas fa-info-circle"></i>';
        }

        toast.innerHTML = `${message} ${iconHtml}`;
        toastContainer.appendChild(toast);

        // Show the toast
        setTimeout(() => {
            toast.classList.add('show');
        }, 10); // Small delay for CSS transition

        // Hide and remove the toast
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => {
                toast.remove();
            });
        }, duration);
    }

    // ... (بقية المتغيرات العالمية والدوال العامة) ...

    /**
     * دالة مساعدة لتحويل تنسيق المواعيد (9ص -> 09:00، p 3 -> 15:00) للفرز والتعامل.
     * تفترض أن "9ص" أو "p 3" تمثل بداية الميعاد.
     * @param {string} timeString - سلسلة الوقت (مثل "9ص", "1:30 م", "p 3", "09:00 - 09:30").
     * @returns {string} الوقت بتنسيق 24 ساعة (HH:mm).
     */
    function convertTo24HourFormat(timeString) {
        if (typeof timeString !== 'string' || timeString.trim() === '') return '00:00';
        timeString = timeString.trim();

        // 1. لو الوقت جاي بتنسيق "HH:MM - HH:MM" (من رؤوس الأعمدة في الشيت)
        const parts = timeString.split(' - ');
        if (parts.length > 1 && parts[0].includes(':')) {
            timeString = parts[0]; // نأخذ جزء البداية فقط (HH:MM)
        }

        // 2. التعامل مع "p X" (مسائي)
        if (timeString.toLowerCase().startsWith('p ')) {
            const hourPart = parseInt(timeString.substring(2)); // الرقم بعد p
            if (!isNaN(hourPart) && hourPart >= 1 && hourPart <= 12) {
                const hour24 = (hourPart === 12) ? 12 : hourPart + 12; // 12م تبقى 12، باقي الأرقام نزيد 12
                return `${hour24.toString().padStart(2, '0')}:00`;
            }
        } 
        // 3. التعامل مع "ص" (صباحي)
        else if (timeString.toLowerCase().endsWith('ص')) {
            const hourPart = parseInt(timeString.replace('ص', ''));
            if (!isNaN(hourPart) && hourPart >= 1 && hourPart <= 12) {
                const hour24 = (hourPart === 12) ? 0 : hourPart; // 12ص (منتصف الليل) تبقى 00، باقي الأرقام كما هي
                return `${hour24.toString().padStart(2, '0')}:00`;
            }
        }
        // 4. التعامل مع "م" (مسائي)
        else if (timeString.toLowerCase().endsWith('م')) {
            const hourPart = parseInt(timeString.replace('م', ''));
            if (!isNaN(hourPart) && hourPart >= 1 && hourPart <= 12) {
                const hour24 = (hourPart === 12) ? 12 : hourPart + 12; // 12م (الظهر) تبقى 12، باقي الأرقام نزيد 12
                return `${hour24.toString().padStart(2, '0')}:00`;
            }
        }
        // 5. التعامل مع التنسيق 00:00 (مثل 09:00) أو 8:30 (بالأرقام فقط)
        else if (timeString.includes(':')) {
            const [hours, minutes] = timeString.split(':').map(Number);
            if (!isNaN(hours) && !isNaN(minutes)) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }
        }
        // 6. لو الوقت رقم فقط (مثل 9 أو 10)
        else {
            const hourPart = parseInt(timeString);
            if (!isNaN(hourPart) && hourPart >= 0 && hourPart <= 23) {
                return `${hourPart.toString().padStart(2, '0')}:00`;
            }
        }
        console.warn("Warning: Could not convert time string to 24-hour format: " + timeString);
        return '00:00'; // Fallback
    }

    /**
     * دالة مساعدة لتحويل سلسلة الوقت (أو رأس الميعاد) إلى دقائق لغرض الفرز.
     * تستخدم convertTo24HourFormat لضمان تحويل أي تنسيق.
     * @param {string} timeString - سلسلة الوقت.
     * @returns {number} الوقت بالدقائق من منتصف الليل.
     */
    function getTimeInMinutes(timeString) {
        if (typeof timeString !== 'string' || timeString.trim() === '') return 0;
        
        const time24hrPart = convertTo24HourFormat(timeString);
        
        const [hours, minutes] = time24hrPart.split(':').map(Number);
        if (isNaN(hours) || isNaN(minutes)) return 0;
        return hours * 60 + minutes;
    }

    /**
     * دالة مساعدة لتحويل تنسيق 24 ساعة (HH:mm) إلى 12 ساعة (H:mm ص/م).
     * @param {string} time24hrPart - الوقت بتنسيق 24 ساعة (مثلاً "13:30").
     * @returns {string} الوقت بتنسيق 12 ساعة (مثلاً "1:30 م").
     */
    function formatTime12Hour(time24hrPart) {
        if (typeof time24hrPart !== 'string' || !time24hrPart.includes(':')) return '';
        // دالة convertTo24HourFormat تضمن أن المدخل هنا هو HH:mm
        const [hours, minutes] = time24hrPart.split(':').map(Number);
        if (isNaN(hours) || isNaN(minutes)) return 'وقت غير صالح';
        const ampm = hours >= 12 ? 'م' : 'ص';
        const formattedHours = hours % 12 || 12;
        return `${formattedHours}:${minutes < 10 ? '0' : ''}${minutes} ${ampm}`;
    }


    // ... (المتغيرات العالمية، دوال showPage, showToast, convertTo24HourFormat, getTimeInMinutes, formatTime12Hour) ...

    // ************************************ //
    //          دوال خاصة بـ form-page      //
    // ************************************ //
    function loadFormDependencies() {
        document.getElementById('dataForm').reset(); // إعادة تهيئة النموذج
        loadTeachersOptions('regTeacher'); // تحميل المعلمين في نموذج التسجيل
        loadPaymentStatusOptions('regPaymentStatus'); // تحميل حالات الدفع
        loadSubscriptionPackagesOptions('regSubscriptionPackage'); // تحميل الباقات
        updateRegDays(); // إعادة ضبط الأيام والمواعيد
    }

    /**
     * تحميل قائمة المعلمين المتاحين لـ form-page
     * @param {string} selectId - ID الخاص بعنصر الـ <select> للمعلمين.
     */
    function loadTeachersOptions(selectId) {
        google.script.run.withSuccessHandler(data => {
            if (data.error) {
                showToast(`خطأ في تحميل المعلمين: ${data.error}`, 'error');
                return;
            }
            teacherData = data; // تخزين البيانات المشتركة
            const teacherSelect = document.getElementById(selectId);
            teacherSelect.innerHTML = '<option value="" disabled selected>اختر معلمًا</option>'; // مسح الخيارات القديمة
            Object.keys(teacherData).forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.textContent = teacher;
                teacherSelect.appendChild(option);
            });
        }).getTeacherData(); // دالة في Code.gs
    }

    /**
     * تحميل قائمة حالات الدفع المتاحة لـ form-page
     * @param {string} selectId - ID الخاص بعنصر الـ <select> لحالة الدفع.
     */
    function loadPaymentStatusOptions(selectId) {
        google.script.run.withSuccessHandler(statuses => {
            const paymentStatusSelect = document.getElementById(selectId);
            paymentStatusSelect.innerHTML = '<option value="" disabled selected>اختر حالة الدفع</option>'; // مسح الخيارات القديمة
            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                paymentStatusSelect.appendChild(option);
            });
        }).getPaymentStatusList(); // دالة في Code.gs
    }

    /**
     * تحميل قائمة باقات الاشتراك لـ form-page
     * @param {string} selectId - ID الخاص بعنصر الـ <select> لباقة الاشتراك.
     */
    function loadSubscriptionPackagesOptions(selectId) {
        google.script.run.withSuccessHandler(packages => {
            const subscriptionPackageSelect = document.getElementById(selectId);
            subscriptionPackageSelect.innerHTML = '<option value="" disabled selected>اختر باقة</option>'; // مسح الخيارات القديمة
            packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg;
                option.textContent = pkg;
                subscriptionPackageSelect.appendChild(option);
            });
        }).getSubscriptionPackageList(); // دالة في Code.gs
    }

    /**
     * تحديث خيارات الأيام المتاحة بناءً على المعلم المختار في form-page.
     */
    function updateRegDays() {
      const teacher = document.getElementById('regTeacher').value;
      const day1Select = document.getElementById('regDay1');
      const day2Select = document.getElementById('regDay2');

      day1Select.innerHTML = '<option value="" disabled selected>اختر يومًا</option>';
      day2Select.innerHTML = '<option value="" disabled selected>اختر يومًا (اختياري)</option>'; 

      document.getElementById('regTime1').innerHTML = '<option value="" disabled selected>اختر ميعادًا</option>';
      document.getElementById('regTime2').innerHTML = '<option value="" disabled selected>اختر ميعادًا (اختياري)</option>';

      if (!teacher || !teacherData[teacher]) {
        return;
      }

      // جلب الأيام الفريدة لهذا المعلم وفرزها
      const daysForTeacher = Object.keys(teacherData[teacher]).sort(); 

      daysForTeacher.forEach(day => {
        const option1 = document.createElement('option');
        const option2 = document.createElement('option');
        option1.value = option2.value = day;
        option1.textContent = option2.textContent = day;
        day1Select.appendChild(option1);
        day2Select.appendChild(option2);
      });
    }

    /**
     * تحديث خيارات المواعيد المتاحة بناءً على اليوم والمعلم المختار في form-page.
     * @param {string} dayId - ID الخاص بعنصر الـ <select> لليوم.
     * @param {string} timeId - ID الخاص بعنصر الـ <select> للميعاد.
     */
    function updateRegTimes(dayId, timeId) {
      const teacher = document.getElementById('regTeacher').value;
      const day = document.getElementById(dayId).value;
      const timeSelect = document.getElementById(timeId);

      timeSelect.innerHTML = '<option value="" disabled selected>اختر ميعادًا</option>';
      if (timeId === 'regTime2') { 
          timeSelect.innerHTML = '<option value="" disabled selected>اختر ميعادًا (اختياري)</option>';
      }

      if (!teacher || !day || !teacherData[teacher][day]) {
        return;
      }

      // جلب المواعيد المتاحة لليوم المحدد وفرزها
      const availableTimes = teacherData[teacher][day].sort((a,b) => getTimeInMinutes(a) - getTimeInMinutes(b));

      availableTimes.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = formatTime12Hour(time); // عرض الميعاد بتنسيق 12 ساعة
        timeSelect.appendChild(option);
      });
    }

    /**
     * إرسال بيانات نموذج التسجيل إلى Code.gs لحفظها.
     */
    function submitData() {
      const name = document.getElementById('regName').value.trim();
      const age = document.getElementById('regAge').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const teacher = document.getElementById('regTeacher').value;
      const day1 = document.getElementById('regDay1').value;
      const time1 = document.getElementById('regTime1').value;
      const paymentStatus = document.getElementById('regPaymentStatus').value;
      const subscriptionPackage = document.getElementById('regSubscriptionPackage').value;

      if (!name || !age || !phone || !teacher || !day1 || !time1 || !paymentStatus || !subscriptionPackage) {
        showToast("الرجاء ملء جميع الحقول المطلوبة.", 'error');
        return;
      }
      
      // التحقق من أن اليوم الثاني والميعاد الثاني، إذا تم اختيار اليوم، يجب اختيار الميعاد أيضاً.
      const day2 = document.getElementById('regDay2').value;
      const time2 = document.getElementById('regTime2').value;

      if (day2 && !time2) {
          showToast("الرجاء اختيار الميعاد الثاني أو إزالة اليوم الثاني.", 'error');
          return;
      }
      if (!day2 && time2) {
          showToast("الرجاء اختيار اليوم الثاني أو إزالة الميعاد الثاني.", 'error');
          return;
      }

      const formData = {
        regName: name,
        regAge: age,
        regPhone: phone,
        regTeacher: teacher,
        regDay1: day1,
        regTime1: time1,
        regDay2: day2, // يمكن أن يكون فارغاً
        regTime2: time2, // يمكن أن يكون فارغاً
        regPaymentStatus: paymentStatus,
        regSubscriptionPackage: subscriptionPackage
      };

      const submitButton = document.querySelector('#form-page .button-primary');
      submitButton.disabled = true;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ التسجيل...';

      google.script.run
        .withSuccessHandler(response => {
          submitButton.disabled = false;
          submitButton.innerHTML = '<i class="fas fa-save"></i> تسجيل البيانات';

          if (response.success) {
            showToast('تم تسجيل البيانات بنجاح!', 'success');
            document.getElementById('dataForm').reset();
            loadFormDependencies(); // إعادة تهيئة النموذج
            showPage('main-page'); // العودة للصفحة الرئيسية
          } else if (response.error) {
            showToast('خطأ في تسجيل البيانات: ' + response.error, 'error');
          }
        })
        .withFailureHandler(error => {
          submitButton.disabled = false;
          submitButton.innerHTML = '<i class="fas fa-save"></i> تسجيل البيانات';
          showToast('حدث خطأ غير متوقع: ' + error.message, 'error');
          console.error("Error submitting data:", error);
        })
        .saveData(formData); // دالة في Code.gs
    }


    // ************************************ //
    //          دوال خاصة بـ all-students-page //
    // ************************************ //
    function loadAllStudentsDependencies() {
        document.getElementById('allStudentsSearch').value = '';
        document.getElementById('filterTeacher').value = '';
        document.getElementById('filterPackage').value = '';
        document.getElementById('filterPaymentStatus').value = '';
        document.getElementById('filterRenewalStatus').value = '';

        loadTeachersOptionsForFilter('filterTeacher'); // دالة لملء قائمة المعلمين في الفلتر
        loadSubscriptionPackagesOptions('filterPackage'); // إعادة استخدام دالة الباقات
        loadPaymentStatusOptions('filterPaymentStatus'); // إعادة استخدام دالة حالات الدفع
        loadRenewalStatusOptions('filterRenewalStatus'); // دالة لملء قائمة حالات التجديد (جديدة/معدلة)

        loadAllStudentsData(); // تحميل بيانات الطلاب
    }
    
    /**
     * تحميل قائمة المعلمين لفلتر صفحة "كل الطلاب".
     * @param {string} selectId - ID الخاص بعنصر الـ <select> للمعلمين.
     */
    function loadTeachersOptionsForFilter(selectId) {
        google.script.run.withSuccessHandler(teachers => {
            const teacherSelect = document.getElementById(selectId);
            teacherSelect.innerHTML = '<option value="">كل المعلمين</option>';
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher; // هنا القيمة هتكون اسم المعلم
                option.textContent = teacher;
                teacherSelect.appendChild(option);
            });
        }).getAllTeachersList(); // دالة في Code.gs
    }

    /**
     * تحميل قائمة حالات التجديد لفلتر صفحة "كل الطلاب".
     * @param {string} selectId - ID الخاص بعنصر الـ <select> لحالة التجديد.
     */
    function loadRenewalStatusOptions(selectId) {
        const renewalStatusSelect = document.getElementById(selectId);
        renewalStatusSelect.innerHTML = '<option value="">كل الحالات</option>';
        const statuses = ["تجريبي", "تم التجديد", "يحتاج للتجديد", "انتهت مدة الاشتراك", "تجاوز الحد", "لم يشترك"]; // أضف "تجريبي" و "لم يشترك"
        statuses.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            renewalStatusSelect.appendChild(option);
        });
    }

    /**
     * جلب بيانات جميع الطلاب وعرضها في جدول صفحة "كل الطلاب".
     */
    function loadAllStudentsData() {
        const tableBody = document.querySelector('#allStudentsTable tbody');
        tableBody.innerHTML = '<tr><td colspan="12" class="no-data-message"><i class="fas fa-spinner fa-spin"></i> جارٍ تحميل بيانات الطلاب...</td></tr>';
        
        const refreshButton = document.querySelector('#all-students-page .refresh-button');
        refreshButton.disabled = true;

        google.script.run
            .withSuccessHandler(data => {
                refreshButton.disabled = false;
                if (data.error) { // لو فيه خطأ من Code.gs
                    tableBody.innerHTML = `<tr><td colspan="12" class="no-data-message" style="color: red;">خطأ في تحميل البيانات: ${data.error}</td></tr>`;
                    showToast(`خطأ في تحميل بيانات الطلاب: ${data.error}`, 'error');
                    console.error("Error loading all students data:", data.error);
                    return;
                }
                allStudentsRawData = data; // تخزين البيانات الخام
                filterAndSortStudents(); // عرض البيانات بعد تحميلها
            })
            .withFailureHandler(error => {
                refreshButton.disabled = false;
                tableBody.innerHTML = `<tr><td colspan="12" class="no-data-message" style="color: red;">خطأ في تحميل البيانات: ${error.message}</td></tr>`;
                showToast(`خطأ في تحميل بيانات الطلاب: ${error.message}`, 'error');
                console.error("Error loading all students data:", error);
            })
            .getAllStudentsData(); // دالة في Code.gs
    }

    /**
     * تصفية وفرز وعرض بيانات الطلاب في الجدول.
     * @param {string} [column=null] - اسم العمود الذي سيتم الفرز على أساسه.
     */
    function filterAndSortStudents(column = null) {
        let filteredData = [...allStudentsRawData]; // نسخ البيانات للعمل عليها

        // 1. تصفية (Filtering)
        const searchTerm = document.getElementById('allStudentsSearch').value.toLowerCase();
        const filterTeacher = document.getElementById('filterTeacher').value;
        const filterPackage = document.getElementById('filterPackage').value;
        const filterPaymentStatus = document.getElementById('filterPaymentStatus').value; // من شيت الطلاب
        const filterRenewalStatus = document.getElementById('filterRenewalStatus').value; // من شيت الاشتراكات

        filteredData = filteredData.filter(student => {
            const matchesSearch = (student.name.toLowerCase().includes(searchTerm) ||
                                   student.studentID.toLowerCase().includes(searchTerm) ||
                                   (student.phone ? student.phone.toString().includes(searchTerm) : false) ||
                                   (student.studentPhone ? student.studentPhone.toString().includes(searchTerm) : false)
                                   );
            const matchesTeacher = filterTeacher === '' || student.teacherName === filterTeacher; // استخدام teacherName
            const matchesPackage = filterPackage === '' || student.packageName === filterPackage; // استخدام packageName
            // تصفية حسب حالة الدفع (من شيت الطلاب) أو حالة التجديد (من شيت الاشتراكات)
            const matchesPaymentStatus = filterPaymentStatus === '' || student.basicStatus === filterPaymentStatus;
            const matchesRenewalStatus = filterRenewalStatus === '' || student.renewalStatus === filterRenewalStatus;


            return matchesSearch && matchesTeacher && matchesPackage && matchesPaymentStatus && matchesRenewalStatus;
        });

        // 2. فرز (Sorting)
        if (column) {
            if (sortColumn === column) {
                sortDirection = (sortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
        }

        if (sortColumn) {
            filteredData.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];

                // التعامل مع null / undefined
                if (valA === null || valA === undefined) valA = '';
                if (valB === null || valB === undefined) valB = '';

                // تحويل القيم الرقمية للفرز الصحيح
                if (sortColumn === 'age' || sortColumn === 'attendedSessions' || sortColumn === 'remainingSessions') {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                } else if (sortColumn === 'registrationDate' || sortColumn === 'subscriptionStartDate' || sortColumn === 'subscriptionEndDate' || sortColumn === 'lastRenewalDate') { // فرز التواريخ
                    valA = valA ? new Date(valA) : new Date(0); // تاريخ افتراضي لو فارغ
                    valB = valB ? new Date(valB) : new Date(0);
                } else if (sortColumn === 'phone' || sortColumn === 'studentPhone' || sortColumn === 'studentID') {
                    valA = String(valA);
                    valB = String(valB);
                } else { // فرز نصي افتراضي
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // 3. عرض البيانات في الجدول
        displayAllStudentsData(filteredData);
    }

    /**
     * عرض البيانات المفلترة والمفرزة في جدول صفحة "كل الطلاب".
     * @param {Array<Object>} students - مصفوفة الطلاب المراد عرضها.
     */
    function displayAllStudentsData(students) {
        const tableBody = document.querySelector('#allStudentsTable tbody');
        tableBody.innerHTML = '';

        if (students.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="12" class="no-data-message">لا توجد بيانات مطابقة لمعايير البحث/التصفية.</td></tr>';
            return;
        }

        students.forEach(student => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${student.name || ''}</td>
                <td>${student.studentID || ''}</td>
                <td>${student.phone || ''}</td>
                <td>${student.teacherName || ''}</td>
                <td>${student.packageName || ''}</td>
                <td>${student.attendedSessions || 0}</td>
                <td>${student.remainingSessions !== undefined ? student.remainingSessions : 'N/A'}</td>
                <td>${student.renewalStatus || ''}</td>
                <td>${student.registrationDate || ''}</td>
                <td>${student.day1 ? `${student.day1} (${formatTime12Hour(student.time1)})` : ''}</td>
                <td>${student.day2 ? `${student.day2} (${formatTime12Hour(student.time2)})` : ''}</td>
                <td class="table-action-buttons">
                    <button class="button button-primary" onclick="editStudentFromAllStudents('${student.studentID}')"><i class="fas fa-edit"></i> تعديل</button>
                    <button class="button delete" onclick="deleteStudentFromAllStudents('${student.studentID}', '${student.name}', ${student.rowIndex})"><i class="fas fa-trash-alt"></i> حذف</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    /**
     * للتحرير من صفحة "كل الطلاب" (ستوجه لصفحة التعديل).
     * @param {string} studentID - Student ID للطالب المراد تعديله.
     */
    function editStudentFromAllStudents(studentID) {
        // بما أننا نستخدم Student ID في الواجهة الجديدة لتعديل الطالب
        // سنحتاج إلى تعديل دالة fetchStudentData في صفحة التعديل
        // أو إضافة دالة جديدة تبحث بـ Student ID.
        // مؤقتاً، سنرسل Student ID وسنعدل صفحة التعديل لاحقاً.
        showPage('edit-student-page', () => {
            // يمكن هنا استدعاء دالة لجلب البيانات بـ ID
            // أو يمكن تهيئة حقل البحث في صفحة التعديل بـ ID هذا
            // ثم استدعاء دالة البحث.
            document.getElementById('searchStudentId').value = studentID; // ID جديد لحقل البحث
            fetchStudentDataByID(); // دالة جديدة للبحث بالـ ID
        });
        showToast('جارٍ الانتقال لصفحة التعديل...', 'info');
    }

    /**
     * لحذف طالب من صفحة "كل الطلاب".
     * @param {string} studentID - Student ID للطالب المراد حذفه.
     * @param {string} studentName - اسم الطالب.
     * @param {number} rowIndex - رقم الصف في شيت "الطلاب".
     */
    function deleteStudentFromAllStudents(studentID, studentName, rowIndex) {
        if (confirm(`هل أنت متأكد أنك تريد حذف الطالب ${studentName} (ID: ${studentID})؟ سيتم نقله إلى الأرشيف.`)) {
            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        showToast(response.success, 'success');
                        loadAllStudentsData(); // إعادة تحميل بيانات الجدول بعد الحذف
                    } else {
                        showToast(response.error, 'error');
                    }
                })
                .withFailureHandler(error => {
                    showToast(`خطأ أثناء حذف الطالب: ${error.message}`, 'error');
                    console.error("Error deleting student from all students page:", error);
                })
                .deleteStudentAndArchive({ studentID: studentID, rowIndex: rowIndex }); // إرسال بيانات كافية للحذف
        }
    }


    // ... (المتغيرات العالمية والدوال العامة مثل showPage, showToast, convertTo24HourFormat, getTimeInMinutes, formatTime12Hour) ...
    // ... (دوال خاصة بـ form-page) ...
    // ... (دوال خاصة بـ all-students-page) ...
    // ... (بقية الدوال الأخرى في index.html، مثل dashboard-page، teacher-schedule-page، manage-slots-page، archive-page) ...


    // ************************************ //
    //          دوال خاصة بـ edit-student-page //
    // ************************************ //
    /**
     * تهيئة صفحة تعديل بيانات الطالب عند عرضها.
     */
    function loadEditStudentDependencies() {
        // إخفاء نموذج التعديل في البداية
        document.getElementById('studentForm').classList.add('hidden'); 
        // مسح حقل البحث
        document.getElementById('searchStudentId').value = ''; 
        // تحميل القوائم المنسدلة: المعلمين، الباقات، حالات الدفع (حالة التجديد)
        loadTeachersOptions('editTeacher'); // دالة موجودة في قسم form-page
        loadSubscriptionPackagesOptions('editSubscriptionPackage'); // دالة موجودة في قسم form-page
        loadPaymentStatusOptions('editPaymentStatus'); // دالة موجودة في قسم form-page
    }

    /**
     * البحث عن بيانات الطالب باستخدام Student ID أو رقم الهاتف.
     * هذه الدالة هي نقطة الدخول الرئيسية للبحث في صفحة التعديل.
     */
    function fetchStudentData() {
        let searchInput = document.getElementById('searchStudentId').value.trim();
        if (!searchInput) {
            showToast("الرجاء إدخال Student ID أو رقم الهاتف للبحث.", 'info');
            return;
        }

        const searchButton = document.getElementById('searchButton');
        const originalSearchText = searchButton.innerHTML;
        searchButton.disabled = true;
        searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> بحث';
        
        // إخفاء أي نموذج سابق للطالب أو رسائل خيارات
        document.getElementById('studentForm').classList.add('hidden'); 
        const existingOptionsContainer = document.getElementById('studentOptionsContainer');
        if (existingOptionsContainer) {
            existingOptionsContainer.remove();
        }

        // تحديد ما إذا كان المدخل Student ID أو رقم هاتف
        let isStudentID = searchInput.startsWith('STD'); // افتراض أن Student ID يبدأ بـ STD
        let runFunction;

        if (isStudentID) {
            runFunction = google.script.run.getStudentDataByID(searchInput); // البحث بـ ID
        } else { 
            // لو مش STD، هنعتبره رقم هاتف
            // إزالة الصفر الأول من رقم الهاتف إذا كان موجودًا للتوافق مع دالة Apps Script
            if (searchInput.startsWith("0")) {
                searchInput = searchInput.slice(1);
            }
            runFunction = google.script.run.getStudentsByPhone(searchInput); // البحث برقم الهاتف
        }

        runFunction
            .withSuccessHandler(studentOrStudents => {
                searchButton.disabled = false;
                searchButton.innerHTML = originalSearchText;

                if (!studentOrStudents || (Array.isArray(studentOrStudents) && studentOrStudents.length === 0)) {
                    showToast("لم يتم العثور على أي طالب بهذا المعرف/الرقم.", 'info');
                    return;
                }

                if (Array.isArray(studentOrStudents)) {
                    // إذا عثر على عدة طلاب بنفس الرقم (فقط عند البحث بالهاتف)
                    showStudentOptionsForEdit(studentOrStudents); 
                } else {
                    // لو طالب واحد (سواء من ID أو من هاتف وحيد)
                    fillStudentForm(studentOrStudents);
                }
            })
            .withFailureHandler(error => {
                searchButton.disabled = false;
                searchButton.innerHTML = originalSearchText;
                showToast("حدث خطأ أثناء البحث: " + error.message, 'error');
                console.error("Error fetching student data for edit:", error);
            });
    }

    /**
     * تُعرض هذه الدالة إذا عثر على عدة طلاب بنفس رقم الهاتف (في صفحة التعديل).
     * @param {Array<Object>} students - مصفوفة الطلاب المطابقين.
     */
    function showStudentOptionsForEdit(students) {
        // إنشاء container جديد لعرض الخيارات
        const container = document.createElement('div');
        container.id = 'studentOptionsContainer'; 
        container.innerHTML = `
            <h3>اختر الطالب الذي تريد تعديل بياناته:</h3>
            <ul id="studentOptionsList"></ul>
        `;
        document.body.appendChild(container); // إضافة الـ container إلى الـ body

        const optionsList = document.getElementById('studentOptionsList');
        students.forEach((student) => {
            const listItem = document.createElement('li');
            const button = document.createElement('button');
            button.className = 'button button-primary';
            button.style.marginBottom = '10px';
            button.textContent = `${student.name} (ID: ${student.studentID || 'غير متاح'}) - هاتف: ${student.phone}`;
            button.onclick = () => {
                document.body.removeChild(container); // إزالة الـ container بعد الاختيار
                fillStudentForm(student);
            };
            listItem.appendChild(button);
            optionsList.appendChild(listItem);
        });
    }

    /**
     * ملء نموذج التعديل ببيانات الطالب التي تم جلبها.
     * @param {Object} student - كائن الطالب المحمل.
     */
    function fillStudentForm(student) {
      studentData = student; // تخزين البيانات العالمية
      document.getElementById('studentForm').classList.remove('hidden');

      // تعبئة البيانات
      document.getElementById('editStudentId').value = student.studentID || '';
      document.getElementById('editName').value = student.name || '';
      document.getElementById('editAge').value = student.age || '';
      document.getElementById('editPhone').value = student.phone || ''; // رقم الهاتف ولي الأمر
      document.getElementById('editTeacher').value = student.teacherName || ''; // اسم المعلم

      // تعبئة المواعيد الحالية
      document.getElementById('currentDay1').textContent = student.day1 ? `${student.day1} (${formatTime12Hour(student.time1)})` : '-';
      document.getElementById('currentTime1').textContent = student.time1 ? formatTime12Hour(student.time1) : '-';
      document.getElementById('currentDay2').textContent = student.day2 ? `${student.day2} (${formatTime12Hour(student.time2)})` : '-';
      document.getElementById('currentTime2').textContent = student.time2 ? formatTime12Hour(student.time2) : '-';

      // تحديث خيارات المعلمين، الباقات، حالات الدفع ثم تعيين القيم
      // هذه الدوال (loadTeachersOptions, loadSubscriptionPackagesOptions, loadPaymentStatusOptions) هي نفس الدوال المستخدمة في Form Page
      loadTeachersOptions('editTeacher'); 
      loadSubscriptionPackagesOptions('editSubscriptionPackage');
      loadPaymentStatusOptions('editPaymentStatus');

      // تأخير بسيط لضمان تحميل الخيارات قبل تعيين القيمة
      setTimeout(() => {
        document.getElementById('editTeacher').value = student.teacherName || ''; // تعيين اسم المعلم
        updateEditDays(); // لتحديث الأيام والمواعيد بناءً على المعلم المختار

        setTimeout(() => {
          document.getElementById('editDay1').value = student.day1 || '';
          updateEditTimes('editDay1', 'editTime1');
          setTimeout(() => {
            document.getElementById('editTime1').value = student.time1 || '';
          }, 50);
          
          document.getElementById('editDay2').value = student.day2 || '';
          updateEditTimes('editDay2', 'editTime2');
          setTimeout(() => {
            document.getElementById('editTime2').value = student.time2 || '';
          }, 50);
        }, 100);

        document.getElementById('editPaymentStatus').value = student.renewalStatus || ''; // حالة التجديد من الاشتراكات
        document.getElementById('editSubscriptionPackage').value = student.packageName || ''; // اسم الباقة
      }, 200); // تأخير أكبر قليلاً
    }

    /**
     * تحديث خيارات الأيام بناءً على المعلم المختار في edit-page.
     */
    function updateEditDays() {
      const teacher = document.getElementById('editTeacher').value;
      const day1Select = document.getElementById('editDay1');
      const day2Select = document.getElementById('editDay2');

      day1Select.innerHTML = '<option value="" disabled selected>اختر يومًا</option>';
      day2Select.innerHTML = '<option value="" disabled selected>اختر يومًا (اختياري)</option>';

      document.getElementById('editTime1').innerHTML = '<option value="" disabled selected>اختر ميعادًا</option>';
      document.getElementById('editTime2').innerHTML = '<option value="" disabled selected>اختر ميعادًا (اختياري)</option>';

      if (!teacher || !teacherData[teacher]) {
        return;
      }

      const daysForTeacher = Object.keys(teacherData[teacher]).sort();

      daysForTeacher.forEach(day => {
        const option1 = document.createElement('option');
        const option2 = document.createElement('option');
        option1.value = option2.value = day;
        option1.textContent = option2.textContent = day;
        day1Select.appendChild(option1);
        day2Select.appendChild(option2);
      });
    }

    /**
     * تحديث خيارات المواعيد بناءً على اليوم والمعلم المختار في edit-page.
     * @param {string} dayId - ID الخاص بعنصر الـ <select> لليوم.
     * @param {string} timeId - ID الخاص بعنصر الـ <select> للميعاد.
     */
    function updateEditTimes(dayId, timeId) {
      const teacher = document.getElementById('editTeacher').value;
      const day = document.getElementById(dayId).value;
      const timeSelect = document.getElementById(timeId);

      timeSelect.innerHTML = '<option value="" disabled selected>اختر ميعادًا</option>';
      if (timeId === 'editTime2') { 
          timeSelect.innerHTML = '<option value="" disabled selected>اختر ميعادًا (اختياري)</option>';
      }

      if (!teacher || !day || !teacherData[teacher][day]) {
        return;
      }
      
      const availableTimes = teacherData[teacher][day].sort((a,b) => getTimeInMinutes(a) - getTimeInMinutes(b));

      availableTimes.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = formatTime12Hour(time);
        timeSelect.appendChild(option);
      });
    }

    /**
     * حفظ البيانات المعدلة للطالب.
     */
    function updateStudentData() {
        // جمع البيانات من النموذج
      const studentId = document.getElementById('editStudentId').value.trim();
      const name = document.getElementById('editName').value.trim();
      const age = document.getElementById('editAge').value.trim();
      const phone = document.getElementById('editPhone').value.trim(); // رقم الهاتف (ولي الأمر)
      const teacherName = document.getElementById('editTeacher').value.trim(); // اسم المعلم
      const day1 = document.getElementById('editDay1').value.trim();
      const time1 = document.getElementById('editTime1').value.trim();
      const day2 = document.getElementById('editDay2').value.trim();
      const time2 = document.getElementById('editTime2').value.trim();
      const paymentStatus = document.getElementById('editPaymentStatus').value.trim(); // حالة التجديد من الاشتراكات
      const subscriptionPackage = document.getElementById('editSubscriptionPackage').value.trim(); // اسم الباقة

      if (!studentId || !name || !age || !phone || !teacherName || !paymentStatus || !subscriptionPackage) {
        showToast("الرجاء ملء جميع الحقول المطلوبة (عدا المواعيد الثانية).", 'error');
        return;
      }
      
      // التأكد من أن اليوم الثاني والميعاد الثاني، إذا تم اختيار اليوم، يجب اختيار الميعاد أيضاً.
      if (day2 && !time2) {
          showToast("الرجاء اختيار الميعاد الثاني أو إزالة اليوم الثاني.", 'error');
          return;
      }
      if (!day2 && time2) {
          showToast("الرجاء اختيار اليوم الثاني أو إزالة الميعاد الثاني.", 'error');
          return;
      }

      const updatedData = {
        studentID: studentId,
        rowIndex: studentData.rowIndex, // رقم الصف في شيت الطلاب
        
        editName: name,
        editAge: age,
        editPhone: phone,
        editTeacher: teacherName, // اسم المعلم
        editDay1: day1,
        editTime1: time1,
        editDay2: day2,
        editTime2: time2,
        editPaymentStatus: paymentStatus, // حالة التجديد
        editSubscriptionPackage: subscriptionPackage,

        // البيانات القديمة لغرض تحرير المواعيد القديمة في Apps Script
        oldTeacherName: studentData.teacherName, // اسم المعلم القديم
        oldDay1: studentData.day1,
        oldTime1: studentData.time1,
        oldDay2: studentData.day2,
        oldTime2: studentData.time2,
      };

      const saveButton = document.querySelector('#edit-student-page .action-buttons-container .button-primary');
      const originalSaveText = saveButton.innerHTML;
      saveButton.disabled = true;
      saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ الحفظ...';

      google.script.run
        .withSuccessHandler(response => {
          saveButton.disabled = false;
          saveButton.innerHTML = originalSaveText;
          if (response.success) {
            showToast('تم حفظ التعديلات بنجاح!', 'success');
            loadEditStudentDependencies(); // إعادة تهيئة الصفحة بعد التعديل
            showPage('main-page'); // العودة للصفحة الرئيسية
          } else if (response.error) {
            showToast('خطأ في حفظ التعديلات: ' + response.error, 'error');
          }
        })
        .withFailureHandler(error => {
          saveButton.disabled = false;
          saveButton.innerHTML = originalSaveText;
          showToast('حدث خطأ غير متوقع: ' + error.message, 'error');
          console.error("Error updating student data:", error);
        })
        .updateStudentDataWithReassignment(updatedData); // دالة في Code.gs
    }

    /**
     * حذف الطالب ونقله إلى الأرشيف.
     */
    function deleteStudent() {
      const studentId = document.getElementById('editStudentId').value.trim();
      const studentName = document.getElementById('editName').value.trim();

      if (!studentId || !studentName) {
        showToast("لا يمكن حذف طالب بدون Student ID أو اسم.", 'error');
        return;
      }

      if (confirm(`هل أنت متأكد أنك تريد حذف الطالب ${studentName} (ID: ${studentId})؟ سيتم نقله إلى الأرشيف.`)) {
        const studentToDelete = {
          studentID: studentId,
          rowIndex: studentData.rowIndex, // رقم الصف في شيت الطلاب
          name: studentName // للمعلومات فقط في رسالة التأكيد
        };

        const deleteButton = document.querySelector('#edit-student-page .action-buttons-container .delete');
        const originalDeleteText = deleteButton.innerHTML;
        deleteButton.disabled = true;
        deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ الحذف...';

        google.script.run
          .withSuccessHandler(response => {
            deleteButton.disabled = false;
            deleteButton.innerHTML = originalDeleteText;
            if (response.success) {
              showToast(response.success, 'success');
              loadEditStudentDependencies(); 
              showPage('main-page');
            } else {
              showToast(response.error, 'error');
            }
          })
          .withFailureHandler(error => {
            deleteButton.disabled = false;
            deleteButton.innerHTML = originalDeleteText;
            showToast('حدث خطأ أثناء حذف الطالب: ' + error.message, 'error');
            console.error("Error deleting student:", error);
          })
          .deleteStudentAndArchive(studentToDelete); // دالة في Code.gs
      }
    }



    // ************************************ //
    //          دوال خاصة بـ dashboard-page //
    // ************************************ //
    // يجب تحميل مكتبة Google Charts مرة واحدة فقط عند تحميل الصفحة
    // google.charts.load('current', {'packages':['corechart']}); 
    // google.charts.setOnLoadCallback(function() {}); // لا نفعل شيئًا هنا، loadDashboardStats ستُنفذ عند دخول الصفحة

    function loadDashboardStats() {
      const loadingText = "جارٍ...";
      document.getElementById('totalStudentsCount').textContent = loadingText;
      document.getElementById('registeredStudentsCount').textContent = loadingText;
      document.getElementById('trialStudentsCount').textContent = loadingText;
      document.getElementById('pendingStudentsCount').textContent = loadingText; // جديد
      document.getElementById('renewalNextWeekCount').textContent = loadingText; 
      document.getElementById('needsRenewalCount').textContent = loadingText;
      document.getElementById('expiredCount').textContent = loadingText;
      document.getElementById('overLimitCount').textContent = loadingText;
      document.getElementById('renewedCount').textContent = loadingText;
      document.getElementById('activeTrialCount').textContent = loadingText; // جديد
      document.getElementById('notSubscribedCount').textContent = loadingText; // جديد
      document.getElementById('studentsByPackageList').innerHTML = '<li>جارٍ تحميل البيانات...</li>';
      document.getElementById('studentsByTeacherList').innerHTML = '<li>جارٍ تحميل البيانات...</li>';
      document.getElementById('last7DaysCount').textContent = loadingText;
      document.getElementById('last30DaysCount').textContent = loadingText;
      
      // مسح الرسوم البيانية القديمة
      document.getElementById('packagePieChart').innerHTML = '<p style="text-align: center; color: #555; padding-top: 150px;">جارٍ تحميل الرسم البياني...</p>';
      document.getElementById('teachersBarChart').innerHTML = '<p style="text-align: center; color: #555; padding-top: 150px;">جارٍ تحميل الرسم البياني...</p>';
      document.getElementById('renewalStatusPieChart').innerHTML = '<p style="text-align: center; color: #555; padding-top: 150px;">جارٍ تحميل الرسم البياني...</p>';
      
      document.getElementById('renewalNextWeekList').innerHTML = '<li>جارٍ تحميل البيانات...</li>';


      const refreshButton = document.querySelector('#dashboard-page .refresh-button');
      if (refreshButton) refreshButton.disabled = true;

      google.script.run
        .withSuccessHandler(stats => {
          if (refreshButton) refreshButton.disabled = false;
          if (stats.error) {
            document.getElementById('dashboard-content').innerHTML = `<p style="color: red; text-align: center;">خطأ في تحميل الإحصائيات: ${stats.error}</p>`;
            showToast(`خطأ: ${stats.error}`, 'error');
            return;
          }
          
          document.getElementById('totalStudentsCount').textContent = stats.totalStudents;
          document.getElementById('registeredStudentsCount').textContent = stats.registeredStudents;
          document.getElementById('trialStudentsCount').textContent = stats.trialStudents;
          document.getElementById('pendingStudentsCount').textContent = stats.pendingStudents; // جديد
          document.getElementById('renewalNextWeekCount').textContent = stats.renewalNextWeek;

          document.getElementById('needsRenewalCount').textContent = stats.renewalStatus.needsRenewal;
          document.getElementById('expiredCount').textContent = stats.renewalStatus.expired;
          document.getElementById('overLimitCount').textContent = stats.renewalStatus.overLimit;
          document.getElementById('renewedCount').textContent = stats.renewalStatus.renewed;
          document.getElementById('activeTrialCount').textContent = stats.renewalStatus.trial; // جديد
          document.getElementById('notSubscribedCount').textContent = stats.renewalStatus.notSubscribed; // جديد

          const studentsByPackageList = document.getElementById('studentsByPackageList');
          studentsByPackageList.innerHTML = '';
          if (Object.keys(stats.studentsByPackage).length === 0) {
              studentsByPackageList.innerHTML = '<li>لا توجد بيانات للباقات حالياً.</li>';
          } else {
              for (const pkg in stats.studentsByPackage) {
                const listItem = document.createElement('li');
                listItem.innerHTML = `${pkg}: <span>${stats.studentsByPackage[pkg]}</span>`;
                studentsByPackageList.appendChild(listItem);
              }
          }

          const studentsByTeacherList = document.getElementById('studentsByTeacherList');
          studentsByTeacherList.innerHTML = '';
          if (Object.keys(stats.studentsByTeacher).length === 0) {
              studentsByTeacherList.innerHTML = '<li>لا توجد بيانات للمعلمين حالياً.</li>';
          } else {
              const sortedTeachers = Object.keys(stats.studentsByTeacher).sort((a, b) => {
                  return stats.studentsByTeacher[b] - stats.studentsByTeacher[a];
              });
              sortedTeachers.forEach(teacher => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `${teacher}: <span>${stats.studentsByTeacher[teacher]}</span>`;
                studentsByTeacherList.appendChild(listItem);
              });
          }

          document.getElementById('last7DaysCount').textContent = stats.recentlyRegistered.last7Days;
          document.getElementById('last30DaysCount').textContent = stats.recentlyRegistered.last30Days;

          // رسم الرسوم البيانية
          drawPackagePieChart(stats.studentsByPackage);
          drawTeachersBarChart(stats.studentsByTeacher);
          drawRenewalStatusPieChart(stats.renewalStatus);

          // قائمة الطلاب الذين يحتاجون للتجديد قريباً
          const renewalNextWeekList = document.getElementById('renewalNextWeekList');
          renewalNextWeekList.innerHTML = '';
          if (stats.renewalNextWeekStudents && stats.renewalNextWeekStudents.length > 0) {
              document.getElementById('renewalDetailsTitle').textContent = `الطلاب (${stats.renewalNextWeekStudents.length}):`;
              stats.renewalNextWeekStudents.forEach(student => {
                  const listItem = document.createElement('li');
                  listItem.innerHTML = `<strong>${student.name}</strong> - هاتف: ${student.phone}`;
                  renewalNextWeekList.appendChild(listItem);
              });
          } else {
              document.getElementById('renewalDetailsTitle').textContent = `لا توجد طلاب يحتاجون للتجديد قريباً.`;
              renewalNextWeekList.innerHTML = '<li>لا توجد بيانات حالياً.</li>';
          }

        })
        .withFailureHandler(error => {
          if (refreshButton) refreshButton.disabled = false;
          const contentDiv = document.getElementById('dashboard-content');
          if (contentDiv) contentDiv.innerHTML = `<p style="color: red; text-align: center;">خطأ في جلب الإحصائيات: ${error.message}</p>`;
          console.error("Error fetching dashboard stats:", error);
          showToast(`خطأ في جلب الإحصائيات: ${error.message}`, 'error');
        })
        .getDashboardStats(); // دالة في Code.gs
    }

    /**
     * دالة لرسم الرسم البياني الدائري لتوزيع الباقات.
     * @param {Object} packageData - بيانات الباقات.
     */
    function drawPackagePieChart(packageData) {
      const dataArray = [['الباقة', 'عدد الطلاب']];
      for (const pkg in packageData) {
        dataArray.push([pkg, packageData[pkg]]);
      }

      if (dataArray.length === 1) { 
        const packageChartDiv = document.getElementById('packagePieChart');
        if (packageChartDiv) packageChartDiv.innerHTML = '<p style="text-align: center; color: #555; padding-top: 150px;">لا توجد بيانات لعرض الرسم البياني للباقات.</p>';
        return;
      }

      const data = google.visualization.arrayToDataTable(dataArray);
      const options = {
        title: 'توزيع الطلاب حسب باقات الاشتراك', is3D: true, fontName: 'Cairo',
        titleTextStyle: { fontSize: 18, color: '#34495e' },
        legend: { textStyle: { fontName: 'Cairo', fontSize: 12 } },
        pieSliceTextStyle: { fontName: 'Cairo', fontSize: 14 },
        backgroundColor: { fill: '#f7f9fc' },
        colors: ['#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6', '#1abc9c', '#f39c12'], 
      };

      const chart = new google.visualization.PieChart(document.getElementById('packagePieChart'));
      chart.draw(data, options);
    }

    /**
     * دالة لرسم الرسم البياني الشريطي لتوزيع الطلاب على المعلمين.
     * @param {Object} teacherData - بيانات المعلمين وعدد طلابهم.
     */
    function drawTeachersBarChart(teacherData) {
        const dataArray = [['المعلم', 'عدد الطلاب']];
        const sortedTeachers = Object.keys(teacherData).sort((a, b) => teacherData[b] - teacherData[a]);
        sortedTeachers.forEach(teacher => {
            dataArray.push([teacher, teacherData[teacher]]);
        });

        if (dataArray.length === 1) {
            document.getElementById('teachersBarChart').innerHTML = '<p style="text-align: center; color: #555; padding-top: 150px;">لا توجد بيانات لعرض الرسم البياني للمعلمين.</p>';
            return;
        }

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            title: 'توزيع الطلاب على المعلمين',
            chartArea: { width: '60%', height: '70%' }, 
            hAxis: { title: 'عدد الطلاب', minValue: 0, textStyle: { fontName: 'Cairo' } },
            vAxis: { title: 'المعلم', textStyle: { fontName: 'Cairo' } },
            legend: { position: 'none' }, 
            backgroundColor: { fill: '#f7f9fc' },
            fontName: 'Cairo',
            titleTextStyle: { fontSize: 18, color: '#34495e' },
            colors: ['#8e44ad'] 
        };

        const chart = new google.visualization.BarChart(document.getElementById('teachersBarChart'));
        chart.draw(data, options);
    }

    /**
     * دالة لرسم الرسم البياني الدائري لحالة تجديد الاشتراكات.
     * @param {Object} renewalStatusData - بيانات حالة التجديد.
     */
    function drawRenewalStatusPieChart(renewalStatusData) {
        const dataArray = [
            ['الحالة', 'عدد الطلاب'],
            ['تم التجديد (نشط)', renewalStatusData.renewed || 0],
            ['يحتاج للتجديد', renewalStatusData.needsRenewal || 0],
            ['انتهت مدة الاشتراك', renewalStatusData.expired || 0],
            ['تجاوز الحد', renewalStatusData.overLimit || 0],
            ['حلقات تجريبية نشطة', renewalStatusData.trial || 0], // جديد
            ['لم يشتركوا', renewalStatusData.notSubscribed || 0] // جديد
        ];

        const total = dataArray.slice(1).reduce((sum, row) => sum + row[1], 0);
        if (total === 0) {
            document.getElementById('renewalStatusPieChart').innerHTML = '<p style="text-align: center; color: #555; padding-top: 150px;">لا توجد بيانات لعرض حالة التجديد.</p>';
            return;
        }

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            title: 'حالة تجديد الاشتراكات',
            is3D: true,
            fontName: 'Cairo',
            titleTextStyle: { fontSize: 18, color: '#34495e' },
            legend: { textStyle: { fontName: 'Cairo', fontSize: 12 } },
            pieSliceTextStyle: { fontName: 'Cairo', fontSize: 14 },
            backgroundColor: { fill: '#f7f9fc' },
            colors: ['#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6', '###3498db', '#bdc3c7'] // ألوان متناسقة، أضف لونين جدد
        };

        const chart = new google.visualization.PieChart(document.getElementById('renewalStatusPieChart'));
        chart.draw(data, options);
    }



    // ************************************ //
    //          دوال خاصة بـ teacher-schedule-page //
    // ************************************ //
    let currentTeacherIdForAttendance = ''; // Teacher ID الحالي الذي تم البحث عنه
    let currentTeacherNameForAttendance = ''; // اسم المعلم الحالي الذي تم البحث عنه
    let currentDayForAttendance = ''; // اليوم الحالي (يتم حسابه تلقائياً)

    function loadTeacherScheduleDependencies() {
        document.getElementById('teacherPhone').value = ''; 
        document.getElementById('teacherInfo').classList.add('hidden');
        document.getElementById('attendanceSection').classList.add('hidden');
        document.getElementById('teacherStatusMessage').classList.add('hidden');
        document.querySelector("#attendanceTable tbody").innerHTML = ''; 

        // تحديد اليوم الحالي تلقائيًا
        const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
        const d = new Date();
        currentDayForAttendance = days[d.getDay()]; 
        document.getElementById('currentDayNameDisplay').textContent = currentDayForAttendance;
    }

    /**
     * تحميل جدول حضور الطلاب لمعلم معين بناءً على رقم هاتفه.
     */
    function loadTeacherSchedule() {
      const teacherPhoneInput = document.getElementById('teacherPhone');
      let phone = teacherPhoneInput.value.trim();

      if (!phone) {
        showToast("الرجاء إدخال رقم هاتف المعلم.", 'info');
        return;
      }

      const searchButton = document.querySelector('#teacher-schedule-page .form-group button');
      const originalButtonText = searchButton.innerHTML;
      searchButton.disabled = true;
      searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> بحث';
      
      document.getElementById('teacherInfo').classList.add('hidden');
      document.getElementById('attendanceSection').classList.add('hidden');
      document.getElementById('teacherStatusMessage').classList.add('hidden');
      document.querySelector("#attendanceTable tbody").innerHTML = '';

      google.script.run
        .withSuccessHandler(response => {
          searchButton.disabled = false;
          searchButton.innerHTML = originalButtonText;

          if (response && response.teacherId) { // لو المعلم موجود
            currentTeacherIdForAttendance = response.teacherId;
            currentTeacherNameForAttendance = response.teacherName;
            document.getElementById('currentTeacherNameDisplay').textContent = `مرحبًا، ${currentTeacherNameForAttendance}`;
            document.getElementById('teacherInfo').classList.remove('hidden');
            
            loadAttendanceStudentsForDisplay(); // استدعاء دالة تحميل الطلاب لهذا المعلم واليوم
          } else {
            showToast('لم يتم العثور على معلم بهذا الرقم.', 'info');
            document.getElementById('teacherStatusMessage').textContent = 'لم يتم العثور على معلم بهذا الرقم.';
            document.getElementById('teacherStatusMessage').classList.remove('hidden');
          }
        })
        .withFailureHandler(error => {
          searchButton.disabled = false;
          searchButton.innerHTML = originalButtonText;
          showToast('حدث خطأ أثناء البحث عن المعلم: ' + error.message, 'error');
          document.getElementById('teacherStatusMessage').textContent = 'حدث خطأ أثناء البحث عن المعلم: ' + error.message;
          document.getElementById('teacherStatusMessage').classList.remove('hidden');
          console.error("Error fetching teacher info:", error);
        })
        .getTeacherInfoByPhone(phone); // دالة في Code.gs
    }

    /**
     * تحميل وعرض الطلاب الذين يجب أن يحضروا للمعلم في اليوم الحالي.
     */
    function loadAttendanceStudentsForDisplay() {
      if (!currentTeacherIdForAttendance || !currentDayForAttendance) {
        showToast('المعلم أو اليوم غير محدد.', 'error');
        return;
      }

      document.getElementById('teacherStatusMessage').textContent = 'جارٍ تحميل طلاب الحضور...';
      document.getElementById('teacherStatusMessage').classList.remove('hidden');

      google.script.run
        .withSuccessHandler(students => {
          document.getElementById('teacherStatusMessage').classList.add('hidden');
          const tableBody = document.querySelector("#attendanceTable tbody");
          tableBody.innerHTML = ''; 

          if (students.error) { // لو فيه خطأ من Apps Script
                showToast(`خطأ في تحميل الطلاب: ${students.error}`, 'error');
                tableBody.innerHTML = `<tr><td colspan="4" class="no-data-message" style="color: red;">خطأ في تحميل البيانات: ${students.error}</td></tr>`;
                document.getElementById('attendanceSection').classList.add('hidden'); 
                return;
          }

          if (!students || students.length === 0) {
            document.getElementById('teacherStatusMessage').textContent = 'لا توجد طلاب لهذا اليوم.';
            document.getElementById('teacherStatusMessage').classList.remove('hidden');
            document.getElementById('attendanceSection').classList.add('hidden'); 
            return;
          }

          document.getElementById('attendanceSection').classList.remove('hidden');
          students.forEach(student => {
            const row = document.createElement('tr');
            // إذا كان تم تسجيل الحضور بالفعل، سنغير شكل الزر
            const buttonClass = student.isMarked ? 'already-marked' : 'attendance-button';
            const buttonText = student.isMarked ? '<i class="fas fa-check-double"></i> تم التسجيل' : '<i class="fas fa-check"></i> تسجيل الحضور';
            const buttonDisabled = student.isMarked ? 'disabled' : '';

            row.innerHTML = `
              <td>${student.name || ''}</td>
              <td>${student.studentID || ''}</td>
              <td>${formatTime12Hour(student.timeSlot || '')}</td> <td><button class="button ${buttonClass}" data-student-id="${student.studentID}" data-time-slot="${student.timeSlot}" ${buttonDisabled} onclick="markAttendance(this)">${buttonText}</button></td>
            `;
            tableBody.appendChild(row);
          });
        })
        .withFailureHandler(error => {
          document.getElementById('teacherStatusMessage').textContent = 'حدث خطأ أثناء تحميل جدول الحضور: ' + error.message;
          document.getElementById('teacherStatusMessage').classList.remove('hidden');
          showToast('حدث خطأ أثناء تحميل جدول الحضور: ' + error.message, 'error');
          console.error("Error loading attendance students:", error);
          document.getElementById('attendanceSection').classList.add('hidden');
        })
        .getAttendanceStudentsForTeacherAndDay(currentTeacherIdForAttendance, currentDayForAttendance); // دالة في Code.gs
    }

    /**
     * تسجيل حضور طالب معين.
     * @param {HTMLButtonElement} buttonElement - زر "تسجيل الحضور" الذي تم النقر عليه.
     */
    function markAttendance(buttonElement) {
      const studentID = buttonElement.getAttribute('data-student-id');
      const timeSlot = buttonElement.getAttribute('data-time-slot'); // الميعاد برأس العمود (HH:mm - HH:mm)

      buttonElement.disabled = true;
      buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ التسجيل...';
      buttonElement.classList.add('already-marked'); 

      google.script.run
        .withSuccessHandler(response => {
          if (response.error) {
            showToast(response.error, 'error');
            // في حالة الخطأ، أعد الزر لوضعه الأصلي
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="fas fa-check"></i> تسجيل الحضور';
            buttonElement.classList.remove('already-marked');
          } else {
            showToast(`${response.success}`, 'success'); // الرسالة تحتوي على اسم الطالب
            buttonElement.innerHTML = '<i class="fas fa-check-double"></i> تم التسجيل'; 
            // لا نلغي disabled لزر "تم التسجيل" لمنع التسجيل المزدوج
            // يمكن إعادة تحميل الجدول لتحديث حالات الأزرار الأخرى
            loadAttendanceStudentsForDisplay(); 
          }
        })
        .withFailureHandler(error => {
          showToast('حدث خطأ أثناء تسجيل الحضور: ' + error.message, 'error');
          buttonElement.disabled = false;
          buttonElement.innerHTML = '<i class="fas fa-check"></i> تسجيل الحضور';
          buttonElement.classList.remove('already-marked');
          console.error("Error marking attendance:", error);
        })
        .markAttendance(currentTeacherIdForAttendance, studentID, currentDayForAttendance, timeSlot); // دالة في Code.gs
    }


    // ************************************ //
    //          دوال خاصة بـ manage-slots-page //
    // ************************************ //



    function loadManageSlotsDependencies() {
        document.getElementById('selectManageTeacher').innerHTML = '<option value="" disabled selected>اختر معلمًا</option>';
        document.getElementById('manageSlotsTeacherInfo').classList.add('hidden');
        document.getElementById('manageSlotsStatusMessage').classList.add('hidden');
        document.getElementById('teacherSlotsTableBody').innerHTML = '';

        // تحميل قائمة المعلمين في القائمة المنسدلة
        google.script.run
            .withSuccessHandler(teachers => {
                const selectElement = document.getElementById('selectManageTeacher');
                if (teachers.error) {
                    showToast(`خطأ في تحميل المعلمين: ${teachers.error}`, 'error');
                    return;
                }
                teachers.forEach(teacherName => { // getAllTeachersList ترجع أسماء المعلمين مباشرة
                    const option = document.createElement('option');
                    option.value = teacherName; // قيمة الأوبشن هتكون اسم المعلم
                    option.textContent = teacherName;
                    selectElement.appendChild(option);
                });
            })
            .withFailureHandler(error => {
                showToast('خطأ في تحميل قائمة المعلمين: ' + error.message, 'error');
                console.error("Error loading teachers for manage slots:", error);
            })
            .getAllTeachersList(); // دالة في Code.gs ترجع أسماء المعلمين فقط
    }

    function loadTeacherSlotsForManagement() {
        const selectElement = document.getElementById('selectManageTeacher');
        const teacherName = selectElement.value; // اسم المعلم من القائمة المنسدلة

        if (!teacherName) {
            document.getElementById('manageSlotsTeacherInfo').classList.add('hidden');
            document.getElementById('manageSlotsStatusMessage').classList.add('hidden');
            document.getElementById('teacherSlotsTableBody').innerHTML = '';
            return;
        }

        const statusMessageDiv = document.getElementById('manageSlotsStatusMessage');
        statusMessageDiv.textContent = 'جارٍ تحميل مواعيد المعلم...';
        statusMessageDiv.classList.remove('hidden');

        document.getElementById('manageSlotsTeacherInfo').classList.add('hidden');
        document.getElementById('teacherSlotsTableBody').innerHTML = '';

        google.script.run
            .withSuccessHandler(response => {
                statusMessageDiv.classList.add('hidden');

                if (response.error) {
                    showToast(response.error, 'error');
                    statusMessageDiv.textContent = response.error;
                    statusMessageDiv.classList.remove('hidden');
                    return;
                }

                if (response.teacherName) {
                    currentManageSlotsTeacherName = response.teacherName;
                    currentManageSlotsTeacherId = response.teacherId; 
                    currentTeacherAllAvailableSlots = response.slots; 

                    document.getElementById('manageSlotsTeacherName').textContent = `المعلم: ${currentManageSlotsTeacherName}`;
                    document.getElementById('manageSlotsTeacherInfo').classList.remove('hidden');

                    // تجميع المواعيد حسب اليوم
                    const slotsByDay = {
                        'الأحد': [], 'الاثنين': [], 'الثلاثاء': [], 'الأربعاء': [],
                        'الخميس': [], 'الجمعة': [], 'السبت': []
                    };
                    response.slots.forEach(slot => { 
                        if (slotsByDay[slot.dayOfWeek]) {
                            slotsByDay[slot.dayOfWeek].push(slot);
                        }
                    });

                    const tableBody = document.getElementById('teacherSlotsTableBody');
                    tableBody.innerHTML = '';

                    let hasSlotsInTable = false;
                    const daysOrder = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                    
                    daysOrder.forEach(day => {
                        const row = document.createElement('tr');
                        const dayCell = document.createElement('td');
                        dayCell.textContent = day;
                        row.appendChild(dayCell);

                        const slotsCell = document.createElement('td');
                        // فرز المواعيد حسب الوقت لعرضها بشكل مرتب
                        const sortedDaySlots = slotsByDay[day].sort((a, b) => getTimeInMinutes(a.timeSlotHeader) - getTimeInMinutes(b.timeSlotHeader));

                        const availableSlots = sortedDaySlots.filter(s => !s.isBooked && s.actualSlotValue === s.timeSlotHeader); // متاح لو فيه رأس العمود
                        const bookedSlots = sortedDaySlots.filter(s => s.isBooked); // محجوزة لو فيها قيمة
                        const notAvailableSlots = sortedDaySlots.filter(s => !s.isBooked && s.actualSlotValue === ''); // غير متاح لو فارغة

                        let slotsText = '';
                        if (availableSlots.length > 0) {
                            slotsText += `متاحة: ${availableSlots.map(s => formatTime12Hour(s.timeSlotHeader)).join(', ')}`;
                        }
                        if (bookedSlots.length > 0) {
                            if (slotsText) slotsText += ' | ';
                            slotsText += `محجوزة: ${bookedSlots.map(s => `${formatTime12Hour(s.timeSlotHeader)} (${s.bookedBy?.name || 'محجوز'})`).join(', ')}`;
                        }
                        if (notAvailableSlots.length > 0) {
                             if (slotsText) slotsText += ' | ';
                             slotsText += `غير متاحة: ${notAvailableSlots.map(s => formatTime12Hour(s.timeSlotHeader)).join(', ')}`;
                        }
                        
                        if (!slotsText && sortedDaySlots.length === 0) { // لو اليوم مفيش فيه أي مواعيد خالص
                            slotsText = 'لا توجد مواعيد مضافة';
                        } else if (!slotsText) { // لو اليوم فيه مواعيد بس كلها غير متاحة أو محجوزة
                             slotsText = 'لا توجد مواعيد متاحة حالياً';
                        }
                        
                        slotsCell.textContent = slotsText;
                        row.appendChild(slotsCell);

                        const actionCell = document.createElement('td');
                        const editButton = document.createElement('button');
                        editButton.className = 'button edit-slots-button';
                        editButton.innerHTML = `<i class="fas fa-edit"></i> تعديل`;
                        editButton.onclick = () => openTimeSlotModal(day);
                        actionCell.appendChild(editButton);
                        row.appendChild(actionCell);
                        
                        tableBody.appendChild(row);
                        if (slotsByDay[day].length > 0 || hasSlotsInTable) { 
                            hasSlotsInTable = true;
                        }
                    });

                    if (!hasSlotsInTable) {
                        document.getElementById('noManageSlotsMessage').classList.remove('hidden');
                    } else {
                        document.getElementById('noManageSlotsMessage').classList.add('hidden');
                    }
                    
                    if (response.message) {
                        statusMessageDiv.textContent = response.message;
                        statusMessageDiv.classList.remove('hidden');
                    } else {
                        statusMessageDiv.classList.add('hidden');
                    }


                } else {
                    showToast('لم يتم العثور على معلم بهذا الاسم.', 'info');
                    statusMessageDiv.textContent = 'لم يتم العثور على معلم بهذا الاسم.';
                    statusMessageDiv.classList.remove('hidden');
                }
            })
            .withFailureHandler(error => {
                statusMessageDiv.classList.add('hidden');
                showToast('حدث خطأ أثناء جلب مواعيد المعلم: ' + error.message, 'error');
                statusMessageDiv.textContent = 'حدث خطأ أثناء جلب مواعيد المعلم: ' + error.message;
                statusMessageDiv.classList.remove('hidden');
                console.error("Error fetching teacher slots for management:", error);
            })
            .getTeacherAvailableSlots(teacherName); // دالة في Code.gs
    }

    // دوال المودال المنبثق لإدارة المواعيد
    function openTimeSlotModal(day) {
        modalSelectedDay = day;
        document.getElementById('modalDayTitle').textContent = `تحديد مواعيد يوم ${day}`;
        const morningGrid = document.getElementById('morningSlotsGrid');
        const eveningGrid = document.getElementById('eveningSlotsGrid');
        morningGrid.innerHTML = '';
        eveningGrid.innerHTML = '';

        const existingSlotsForSelectedDay = currentTeacherAllAvailableSlots.filter(s => s.dayOfWeek === day);
        
        // المواعيد التي ستعرض للاختيار (كل رؤوس الأعمدة المحتملة)
        const sortedDisplayHeaders = [...possibleTimeSlots24Hour];
        sortedDisplayHeaders.sort((a,b) => getTimeInMinutes(a) - getTimeInMinutes(b)); 

        // تهيئة modalSelectedSlots
        // في هذا المنطق الجديد، modalSelectedSlots ستحتوي فقط على المواعيد التي "نريد جعلها متاحة"
        // أي المواعيد التي كانت بالفعل متاحة (تحتوي على رأس العمود)
        modalSelectedSlots = existingSlotsForSelectedDay.filter(s => !s.isBooked && s.actualSlotValue === s.timeSlotHeader).map(slot => ({ ...slot }));


        if (sortedDisplayHeaders.length === 0) {
            morningGrid.innerHTML = '<p class="no-slots-message">لا توجد مواعيد متاحة في هذا اليوم.</p>';
            eveningGrid.innerHTML = '';
            return;
        }

        let hasMorningSlots = false;
        let hasEveningSlots = false;

        sortedDisplayHeaders.forEach(timeSlotHeader => { // هنا نمر على رؤوس الأعمدة المحتملة
            // نبحث عن الموعد الأصلي في بيانات المعلم (عشان نعرف لو محجوز)
            const originalSlotData = existingSlotsForSelectedDay.find(s => s.timeSlotHeader === timeSlotHeader);
            
            // هل هذا الموعد تم تحديده ليكون متاحاً في المودال؟
            const isSelected = modalSelectedSlots.some(s => s.timeSlotHeader === timeSlotHeader);
            
            // هل هذا الموعد محجوز من قبل طالب (أو نص مخصص)؟ لا يمكن التلاعب به.
            const isDisabled = originalSlotData && originalSlotData.isBooked;

            const button = document.createElement('button');
            button.className = `time-slot-chip ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}`;
            button.type = 'button';
            button.onclick = () => toggleSlotSelection(timeSlotHeader); 
            button.disabled = isDisabled;
            button.setAttribute('data-time-slot-header', timeSlotHeader); 
            
            let buttonText = timeSlotHeader; // نص الزر هو رأس العمود
            if (originalSlotData && originalSlotData.isBooked) {
                // لو محجوز بـ ID طالب
                if (originalSlotData.bookedBy && originalSlotData.bookedBy._id && (originalSlotData.bookedBy._id.startsWith("STD") || originalSlotData.bookedBy._id.startsWith("p "))) {
                    buttonText += ` (${originalSlotData.bookedBy.name || originalSlotData.bookedBy._id})`;
                }
                // لو محجوز بنص مخصص
                else if (originalSlotData.bookedBy && originalSlotData.bookedBy.name) {
                    buttonText += ` (${originalSlotData.bookedBy.name})`;
                }
                else { // لو مش عارفين مين حجز
                     buttonText += ` (محجوز)`;
                }
            }
            button.textContent = buttonText;

            const startMinutes = getTimeInMinutes(timeSlotHeader);

            if (startMinutes >= getTimeInMinutes("09:00 - 00:00") && startMinutes < getTimeInMinutes("15:00 - 00:00")) {
                morningGrid.appendChild(button);
                hasMorningSlots = true;
            } else if (startMinutes >= getTimeInMinutes("15:00 - 00:00") && startMinutes <= getTimeInMinutes("23:30 - 00:00")) { 
                eveningGrid.appendChild(button);
                hasEveningSlots = true;
            }
        });
        
        if (!hasMorningSlots && morningGrid.innerHTML === '') {
            morningGrid.innerHTML = '<p class="no-slots-message">لا توجد مواعيد صباحية متاحة.</p>';
        }
        if (!hasEveningSlots && eveningGrid.innerHTML === '') {
            eveningGrid.innerHTML = '<p class="no-slots-message">لا توجد مواعيد مسائية متاحة.</p>';
        }

        document.getElementById('timeSlotSelectionModal').classList.remove('hidden');
    }

    function toggleSlotSelection(timeSlotHeader) { 
        const originalSlotData = currentTeacherAllAvailableSlots.find(
            s => s.dayOfWeek === modalSelectedDay && s.timeSlotHeader === timeSlotHeader
        );

        if (originalSlotData && originalSlotData.isBooked) {
            showToast('لا يمكن إلغاء تحديد هذا الموعد المحجوز من قبل طالب أو نص مخصص.', 'info');
            return;
        }

        const index = modalSelectedSlots.findIndex(s => s.timeSlotHeader === timeSlotHeader);
        if (index > -1) {
            // الموعد كان مختاراً ليصبح متاحاً، سيتم إلغاء تحديده (أي يصبح فارغاً في الشيت)
            modalSelectedSlots.splice(index, 1);
        } else {
            // الموعد لم يكن مختاراً، سيتم تحديده (أي نضع رأس العمود في الخلية)
            modalSelectedSlots.push({ 
                dayOfWeek: modalSelectedDay, 
                timeSlotHeader: timeSlotHeader, 
                actualSlotValue: timeSlotHeader, // نضع رأس العمود كقيمة فعلية للمتاح
                isBooked: false, 
                bookedBy: null 
            });
        }
        updateModalButtons();
    }

    function saveSelectedSlots() {
        const teacherId = currentManageSlotsTeacherId;
        const day = modalSelectedDay;
        
        const newSelectedSlotsToSend = modalSelectedSlots.map(slot => ({
            dayOfWeek: slot.dayOfWeek,
            timeSlotHeader: slot.timeSlotHeader
        }));


        if (!teacherId || !day) {
            showToast('خطأ: لم يتم تحديد المعلم أو اليوم.', 'error');
            return;
        }
        
        const saveButton = document.querySelector('#timeSlotSelectionModal .save-button');
        const originalSaveText = saveButton.innerHTML;
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ الحفظ...';

        google.script.run
            .withSuccessHandler(response => {
                saveButton.disabled = false;
                saveButton.innerHTML = originalSaveText;
                if (response.success) {
                    showToast(response.success, 'success');
                    closeTimeSlotModal();
                    loadTeacherSlotsForManagement(); // إعادة تحميل الجدول بعد الحفظ
                } else {
                    showToast(response.error, 'error');
                }
            })
            .withFailureHandler(error => {
                saveButton.disabled = false;
                saveButton.innerHTML = originalSaveText;
                showToast('حدث خطأ أثناء حفظ المواعيد: ' + error.message, 'error');
                console.error("Error saving selected slots:", error);
            })
            .updateTeacherSlots(teacherId, day, newSelectedSlotsToSend); 
    }


    
    // ************************************ //
    //          دوال خاصة بـ archive-page     //
    // ************************************ //

    function loadArchivedStudentsDependencies() {
        document.getElementById('archiveSearch').value = '';
        document.getElementById('filterArchiveTeacher').value = '';
        document.getElementById('filterArchivePackage').value = '';
        document.getElementById('filterArchiveStatus').value = ''; // حالة الطالب وقت الأرشفة

        loadTeachersOptionsForFilter('filterArchiveTeacher'); // إعادة استخدامها لملء قائمة المعلمين
        loadSubscriptionPackagesOptions('filterArchivePackage'); // إعادة استخدامها لملء قائمة الباقات
        loadArchivedStudentStatusOptions('filterArchiveStatus'); // دالة جديدة لحالة الطالب وقت الأرشفة

        loadArchivedStudentsData(); // تحميل بيانات الطلاب المؤرشفين
    }

    /**
     * تحميل قائمة حالات الطالب (للفلترة في الأرشيف).
     * @param {string} selectId - ID الخاص بعنصر الـ <select>.
     */
    function loadArchivedStudentStatusOptions(selectId) {
        const statusSelect = document.getElementById(selectId);
        statusSelect.innerHTML = '<option value="">كل الحالات</option>';
        const statuses = ["مشترك", "تجريبي", "قيد التسجيل", "معلق", "منسحب"]; // الحالات الأساسية للطالب
        statuses.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            statusSelect.appendChild(option);
        });
    }

    /**
     * جلب بيانات جميع الطلاب المؤرشفين وعرضها في جدول صفحة الأرشيف.
     */
    function loadArchivedStudentsData() {
        const tableBody = document.querySelector('#archivedStudentsTable tbody');
        tableBody.innerHTML = '<tr><td colspan="8" class="no-data-message"><i class="fas fa-spinner fa-spin"></i> جارٍ تحميل بيانات الطلاب المؤرشفين...</td></tr>';
        
        const refreshButton = document.querySelector('#archive-page .refresh-button');
        refreshButton.disabled = true;

        google.script.run
            .withSuccessHandler(data => {
                refreshButton.disabled = false;
                if (data.error) { 
                    tableBody.innerHTML = `<tr><td colspan="8" class="no-data-message" style="color: red;">خطأ في تحميل البيانات: ${data.error}</td></tr>`;
                    showToast(`خطأ في تحميل بيانات الأرشيف: ${data.error}`, 'error');
                    console.error("Error loading archived students data:", data.error);
                    return;
                }
                archivedStudentsRawData = data; 
                filterAndSortArchivedStudents();
            })
            .withFailureHandler(error => {
                refreshButton.disabled = false;
                tableBody.innerHTML = `<tr><td colspan="8" class="no-data-message" style="color: red;">خطأ في تحميل البيانات: ${error.message}</td></tr>`;
                showToast(`خطأ في تحميل بيانات الأرشيف: ${error.message}`, 'error');
                console.error("Error loading archived students data:", error);
            })
            .getArchivedStudentsData(); // دالة في Code.gs
    }

    

    /**
     * تصفية وفرز وعرض بيانات الطلاب المؤرشفين في الجدول.
     * @param {string} [column=null] - اسم العمود الذي سيتم الفرز على أساسه.
     */
    function filterAndSortArchivedStudents(column = null) {
        let filteredData = [...archivedStudentsRawData];

        // 1. تصفية (Filtering)
        const searchTerm = document.getElementById('archiveSearch').value.toLowerCase();
        const filterTeacher = document.getElementById('filterArchiveTeacher').value;
        const filterPackage = document.getElementById('filterArchivePackage').value;
        const filterStatus = document.getElementById('filterArchiveStatus').value; // الحالة الأساسية للطالب وقت الأرشفة

        filteredData = filteredData.filter(student => {
            const matchesSearch = (student.name.toLowerCase().includes(searchTerm) ||
                                   student.studentID.toLowerCase().includes(searchTerm) ||
                                   (student.phone ? student.phone.toString().includes(searchTerm) : false) ||
                                   (student.studentPhone ? student.studentPhone.toString().includes(searchTerm) : false)
                                   );
            const matchesTeacher = filterTeacher === '' || student.teacherName === filterTeacher; // assuming teacherName exists in archived data
            const matchesPackage = filterPackage === '' || student.packageName === filterPackage; // assuming packageName exists in archived data
            const matchesStatus = filterStatus === '' || student.basicStatus === filterStatus; // basicStatus

            return matchesSearch && matchesTeacher && matchesPackage && matchesStatus;
        });

        // 2. فرز (Sorting)
        if (column) {
            if (archiveSortColumn === column) {
                archiveSortDirection = (archiveSortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                archiveSortColumn = column;
                archiveSortDirection = 'asc';
            }
        }

        if (archiveSortColumn) {
            filteredData.sort((a, b) => {
                let valA = a[archiveSortColumn];
                let valB = b[archiveSortColumn];

                if (valA === null || valA === undefined) valA = '';
                if (valB === null || valB === undefined) valB = '';

                if (archiveSortColumn === 'age') { // لو السن
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                } else if (archiveSortColumn === 'archivedDate' || archiveSortColumn === 'registrationDate') { // فرز التواريخ
                    valA = valA ? new Date(valA) : new Date(0);
                    valB = valB ? new Date(valB) : new Date(0);
                } else { // فرز نصي افتراضي
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return archiveSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return archiveSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // 3. عرض البيانات في الجدول
        displayArchivedStudentsData(filteredData);
    }

    /**
     * عرض البيانات المفلترة والمفرزة في جدول صفحة الأرشيف.
     * @param {Array<Object>} students - مصفوفة الطلاب المراد عرضها.
     */
    function displayArchivedStudentsData(students) {
        const tableBody = document.querySelector('#archivedStudentsTable tbody');
        tableBody.innerHTML = '';

        if (students.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="no-data-message">لا توجد بيانات مطابقة لمعايير البحث/التصفية في الأرشيف.</td></tr>';
            return;
        }

        students.forEach(student => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${student.name || ''}</td>
                <td>${student.studentID || ''}</td>
                <td>${student.phone || ''}</td>
                <td>${student.teacherName || ''}</td> <td>${student.packageName || ''}</td> <td>${student.archivedDate || ''}</td>
                <td>${student.archiveReason || ''}</td>
                <td class="table-action-buttons">
                    <button class="button button-primary" onclick="reactivateArchivedStudent('${student.studentID}', '${student.name}')"><i class="fas fa-undo"></i> إعادة تفعيل</button>
                    </td>
            `;
            tableBody.appendChild(row);
        });
    }

    /**
     * إعادة تفعيل طالب من الأرشيف.
     * @param {string} studentID - Student ID للطالب.
     * @param {string} studentName - اسم الطالب.
     */
    function reactivateArchivedStudent(studentID, studentName) {
        if (confirm(`هل أنت متأكد من رغبتك في إعادة تفعيل الطالب ${studentName} (ID: ${studentID})؟`)) {
            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        showToast(response.success, 'success');
                        loadArchivedStudentsData(); // إعادة تحميل جدول الأرشيف
                    } else {
                        showToast(response.error, 'error');
                    }
                })
                .withFailureHandler(error => {
                    showToast(`خطأ أثناء إعادة تفعيل الطالب: ${error.message}`, 'error');
                    console.error("Error reactivating student:", error);
                })
                .reactivateStudentFromArchive(studentID); // دالة في Code.gs
        }
    }


    // ************************************ //
    //          كود التنفيذ عند تحميل الصفحة          //
    // ************************************ //
    document.addEventListener('DOMContentLoaded', function() {
      // جلب الـ Base URL (رابط التطبيق) عند تحميل الصفحة
      google.script.run.withSuccessHandler(function(url) {
        // لا نحتاج لـ baseUrl في هذا النظام لأن التنقل يتم داخل نفس index.html
        // ولكن يمكن استخدامها للتأكد أن اتصال Apps Script يعمل
        console.log('Base URL loaded successfully:', url);
      }).getBaseUrl();

      // تحديد اليوم الحالي تلقائيًا لصفحة حضور المعلمين
      const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
      const d = new Date();
      currentDay = days[d.getDay()]; 

      // عرض الصفحة الرئيسية عند تحميل التطبيق لأول مرة
      showPage('main-page'); 
    });

    // الدوال الخاصة بكل صفحة ستضاف هنا لاحقاً...
    // (loadDashboardStats, loadFormDependencies, submitData, loadAllStudentsData,
    //  loadEditStudentDependencies, fetchStudentData, loadTeacherScheduleDependencies,
    //  loadManageSlotsDependencies, openTimeSlotModal, saveSelectedSlots, إلخ)

  </script>
</body>
</html>
